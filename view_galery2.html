<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidan Cloud - Viewer Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root { --blue: #0078d7; --bg: #f5f5f5; --border: #ddd; --card-bg: #ffffff; --text: #333; --danger: #d93025; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

        header { background: white; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .path-bar { flex: 1; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; background: #fff; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .path-bar span { cursor: pointer; color: var(--blue); font-weight: 600; }
        .btn-action { background: transparent; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-delete { color: var(--danger); border-color: var(--danger); }
        .btn-delete:hover { background: #fff1f0; }

        #explorerContainer { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
        
        .item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .item:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--blue); }
        .item.selected { border-color: var(--blue); background: #eef7ff; }
        
        .item-checkbox { position: absolute; top: 8px; left: 8px; z-index: 10; width: 18px; height: 18px; cursor: pointer; }

        .icon-box { height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden; border-radius: 8px; background: #ececec; position: relative; }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .icon-box video { width: 100%; height: 100%; object-fit: cover; }
        .folder-icon { font-size: 60px; color: #ffca28; }
        .file-icon { font-size: 40px; color: #90a4ae; }
        
        .file-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        
        .name { font-size: 13px; font-weight: 500; word-break: break-all; height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; }

        #playerOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        .player-header { position: absolute; top: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%); padding: 20px 80px 40px 20px; z-index: 10000; }
        .player-filename { color: white; font-size: 18px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .player-info { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; z-index: 10001; backdrop-filter: blur(5px); }

        .player-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10001; background: rgba(0,0,0,0.6); padding: 12px 20px; border-radius: 50px; backdrop-filter: blur(10px); }
        .control-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .control-btn.active { background: var(--blue); color: white; }

        .swiper { width: 100%; height: 100%; padding-top: 80px; padding-bottom: 80px; }
        .swiper-slide { display: flex; justify-content: center; align-items: center; background: #000; color: white; }
        video, .player-image { max-width: 100%; max-height: 100%; object-fit: contain; outline: none; }
        .audio-card { background: #1a1a1a; padding: 40px; border-radius: 24px; text-align: center; width: 85%; max-width: 400px; border: 1px solid #333; }
        
        .loader { position: absolute; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #loginOverlay { position: fixed; inset: 0; background: #f0f2f5; display: flex; justify-content: center; align-items: center; z-index: 10002; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 340px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-login { width: 100%; background: var(--blue); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        @media (max-width: 768px) {
            .player-controls { bottom: 10px; padding: 8px 12px; }
            .control-btn { padding: 8px 14px; font-size: 11px; }
        }
    </style>
</head>
<body onkeydown="if(event.key==='Escape') closePlayer()">

<div id="loginOverlay" style="display:none">
    <div class="login-card">
        <h2>Lidan Cloud</h2>
        <input type="text" id="userInp" placeholder="Username">
        <input type="password" id="passInp" placeholder="Password">
        <button onclick="doLogin()" class="btn-login">Masuk</button>
    </div>
</div>

<header>
    <button onclick="muatData()" class="btn-action">üîÑ</button>
    <div class="path-bar" id="pathBar"></div>
    <button id="deleteBtn" onclick="deleteSelected()" class="btn-action btn-delete" style="display:none">üóëÔ∏è Hapus</button>
    <button onclick="doLogout()" class="btn-action">Keluar</button>
</header>

<main id="explorerContainer">
    <div class="grid" id="explorer"></div>
</main>

<div id="playerOverlay">
    <div class="player-header">
        <h2 class="player-filename" id="playerFilename">Loading...</h2>
        <div class="player-info" id="playerInfo"></div>
    </div>
    <button class="close-btn" onclick="closePlayer()">‚úï</button>
    
    <div class="player-controls">
        <button class="control-btn" id="autoplayBtn" onclick="toggleAutoplay()">
            <span class="icon">‚ñ∂Ô∏è</span><span>Autoplay</span>
        </button>
        <button class="control-btn" id="autoNextBtn" onclick="toggleAutoNext()">
            <span class="icon">‚è≠Ô∏è</span><span>Auto Next</span>
        </button>
    </div>
    
    <div class="swiper">
        <div class="swiper-wrapper" id="playerWrapper"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    const API_URL = "https://cipta.my.id/api/r2_api";
    const API_LOGIN = "https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6";
    let allData = [], currentPath = "", mediaFiles = [], swiperInstance = null;
    let selectedKeys = new Set();
    
    let autoplayEnabled = false;
    let autoNextEnabled = false;

    function getToken() { return localStorage.getItem('lidan_token'); }
    
    async function doLogin() {
        const u = document.getElementById('userInp').value;
        const p = document.getElementById('passInp').value;
        const res = await fetch(`${API_LOGIN}?action=login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Role': 'admin', 'X-Custom-Auth': 'admin' },
            body: JSON.stringify({ username: u, password: p })
        });
        const data = await res.json();
        if (data.success) { localStorage.setItem('lidan_token', btoa(`${u}:${p}`)); initApp(); }
        else alert("Login Gagal");
    }
    
    function doLogout() { localStorage.removeItem('lidan_token'); location.reload(); }

    function initApp() {
        if (!getToken()) { document.getElementById('loginOverlay').style.display = 'flex'; return; }
        document.getElementById('loginOverlay').style.display = 'none';
        autoplayEnabled = localStorage.getItem('autoplayEnabled') === 'true';
        autoNextEnabled = localStorage.getItem('autoNextEnabled') === 'true';
        muatData();
    }

    async function muatData() {
        try {
            // Sesuai r2_api.js: Fetch awal tanpa folder/cursor mengembalikan Array
            const res = await fetch(`${API_URL}?action=list`);
            allData = await res.json();
            render();
        } catch(e) { console.error(e); }
    }

    function render() {
        const explorer = document.getElementById('explorer');
        const pathBar = document.getElementById('pathBar');
        explorer.innerHTML = "";
        selectedKeys.clear();
        updateDeleteButton();

        pathBar.innerHTML = `<span onclick="goPath('')">Root</span>`;
        let bPath = "";
        currentPath.split('/').filter(x=>x).forEach(part => {
            bPath += (bPath ? "/" : "") + part;
            const target = bPath;
            pathBar.innerHTML += ` / <span onclick="goPath('${target}')">${part}</span>`;
        });

        let folders = new Set();
        mediaFiles = [];
        allData.forEach(item => {
            const rel = currentPath === "" ? item.key : item.key.substring(currentPath.length + 1);
            if (!item.key.startsWith(currentPath)) return;
            if (currentPath !== "" && !item.key.startsWith(currentPath + "/")) return;
            const parts = rel.split('/').filter(x => x);
            if (parts.length > 1) folders.add(parts[0]);
            else if (parts.length === 1 && parts[0] !== ".folder") mediaFiles.push(item);
        });

        folders.forEach(f => {
            const fPath = currentPath === "" ? f : currentPath + "/" + f;
            explorer.appendChild(createCard(`<span class="folder-icon">üìÅ</span>`, f, () => goPath(fPath), true, {key: fPath}));
        });

        mediaFiles.forEach((file, index) => {
            const ext = file.key.split('.').pop().toLowerCase();
            let icon;
            if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                icon = `<img src="${file.url}" loading="lazy"><span class="file-badge">IMG</span>`;
            } else if (['mp4','webm'].includes(ext)) {
                icon = `<video src="${file.url}" preload="metadata" muted></video><span class="file-badge">VIDEO</span>`;
            } else if (['mp3','wav','ogg','m4a'].includes(ext)) {
                icon = `<span class="file-icon">üéµ</span><span class="file-badge">AUDIO</span>`;
            } else {
                icon = `<span class="file-icon">üìÑ</span><span class="file-badge">${ext.toUpperCase()}</span>`;
            }
            explorer.appendChild(createCard(icon, file.key.split('/').pop(), () => openPlayer(index), false, file, index));
        });
    }

    function createCard(icon, name, action, isFolder, fileData, index) {
        const div = document.createElement('div');
        div.className = 'item';
        div.id = isFolder ? "" : `file-item-${index}`;
        
        let checkboxHtml = "";
        if(!isFolder) {
            checkboxHtml = `<input type="checkbox" class="item-checkbox" data-key="${fileData.key}" onclick="toggleSelect(event, '${fileData.key}', this)">`;
        }

        div.innerHTML = `${checkboxHtml}<div class="icon-box">${icon}</div><div class="name">${name}</div>`;
        div.onclick = action;
        return div;
    }

    function toggleSelect(event, key, checkbox) {
        event.stopPropagation();
        if(checkbox.checked) {
            selectedKeys.add(key);
            checkbox.closest('.item').classList.add('selected');
        } else {
            selectedKeys.delete(key);
            checkbox.closest('.item').classList.remove('selected');
        }
        updateDeleteButton();
    }

    function updateDeleteButton() {
        const btn = document.getElementById('deleteBtn');
        btn.style.display = selectedKeys.size > 0 ? 'flex' : 'none';
        btn.innerText = `üóëÔ∏è Hapus (${selectedKeys.size})`;
    }

    // FUNGSI DELETE YANG DISINKRONKAN DENGAN r2_api.js
    async function deleteSelected() {
        if(!confirm(`Hapus ${selectedKeys.size} item terpilih selamanya?`)) return;
        
        const keysToDelete = Array.from(selectedKeys);
        let successCount = 0;

        for(let key of keysToDelete) {
            try {
                // Mengirim request POST action=delete sesuai file r2_api.js
                const response = await fetch(`${API_URL}?action=delete`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Custom-Auth': 'admin' 
                    },
                    body: JSON.stringify({ 
                        key: key, 
                        auth: "admin" 
                    })
                });

                if (response.ok) {
                    successCount++;
                } else {
                    const err = await response.json();
                    console.error(`Gagal hapus ${key}:`, err.error);
                }
            } catch (e) { 
                console.error("Network Error:", e); 
            }
        }
        
        if (successCount > 0) {
            alert(`Berhasil menghapus ${successCount} file.`);
            selectedKeys.clear();
            muatData(); // Memuat ulang data dari server
        }
    }

    function updatePlayerInfo(index) {
        const file = mediaFiles[index];
        const filename = file.key.split('/').pop();
        const ext = file.key.split('.').pop().toLowerCase();
        document.getElementById('playerFilename').textContent = filename;
        document.getElementById('playerInfo').textContent = `${index + 1} / ${mediaFiles.length} ‚Ä¢ ${ext.toUpperCase()}`;
    }

    function toggleAutoplay() {
        autoplayEnabled = !autoplayEnabled;
        localStorage.setItem('autoplayEnabled', autoplayEnabled);
        updateControlButtons();
    }

    function toggleAutoNext() {
        autoNextEnabled = !autoNextEnabled;
        localStorage.setItem('autoNextEnabled', autoNextEnabled);
        updateControlButtons();
    }

    function updateControlButtons() {
        const autoplayBtn = document.getElementById('autoplayBtn');
        const autoNextBtn = document.getElementById('autoNextBtn');
        autoplayEnabled ? autoplayBtn.classList.add('active') : autoplayBtn.classList.remove('active');
        autoNextEnabled ? autoNextBtn.classList.add('active') : autoNextBtn.classList.remove('active');
    }

    function openPlayer(startIndex) {
        const wrapper = document.getElementById('playerWrapper');
        wrapper.innerHTML = "";
        mediaFiles.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            const ext = file.key.split('.').pop().toLowerCase();
            if (['mp4','webm'].includes(ext)) slide.innerHTML = `<video data-src="${file.url}" controls playsinline loop preload="none"></video><div class="loader"></div>`;
            else if (['jpg','jpeg','png','gif','webp'].includes(ext)) slide.innerHTML = `<img data-src="${file.url}" class="player-image">`;
            else slide.innerHTML = `<div class="audio-card">üéµ<br><audio data-src="${file.url}" controls preload="none"></audio></div>`;
            wrapper.appendChild(slide);
        });

        document.getElementById('playerOverlay').style.display = 'flex';
        updatePlayerInfo(startIndex);
        updateControlButtons();
        
        if(swiperInstance) swiperInstance.destroy(true, true);

        swiperInstance = new Swiper('.swiper', {
            initialSlide: startIndex,
            direction: window.innerWidth < 768 ? 'vertical' : 'horizontal',
            speed: 400,
            keyboard: true,
            on: {
                init: function() { loadMedia(this, this.activeIndex); },
                slideChange: function() {
                    stopAllMedia();
                    loadMedia(this, this.activeIndex);
                    updatePlayerInfo(this.activeIndex);
                }
            }
        });
    }

    function loadMedia(swiper, index) {
        const activeSlide = swiper.slides[index];
        const media = activeSlide.querySelector('video, img, audio');
        if (media && media.getAttribute('data-src')) {
            media.src = media.getAttribute('data-src');
            media.removeAttribute('data-src');
            if (media.tagName !== 'IMG') {
                const loader = activeSlide.querySelector('.loader');
                if(loader) loader.style.display = 'block';
                media.oncanplay = () => { if(loader) loader.style.display = 'none'; };
                media.onended = () => {
                    if (autoNextEnabled && swiper.activeIndex < mediaFiles.length - 1) {
                        setTimeout(() => { swiper.slideNext(); }, 500);
                    }
                };
                if (autoplayEnabled) media.play().catch(() => {});
            }
        }
    }

    function stopAllMedia() { 
        document.querySelectorAll('video, audio').forEach(m => { m.pause(); m.onended = null; });
    }

    function closePlayer() {
        const lastIndex = swiperInstance ? swiperInstance.activeIndex : -1;
        document.getElementById('playerOverlay').style.display = 'none';
        stopAllMedia();
        document.querySelectorAll('#playerWrapper video, #playerWrapper audio').forEach(m => { m.src = ""; m.load(); });

        if(lastIndex !== -1) {
            const lastViewedElement = document.getElementById(`file-item-${lastIndex}`);
            if(lastViewedElement) {
                lastViewedElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                lastViewedElement.style.outline = "2px solid var(--blue)";
                setTimeout(() => { lastViewedElement.style.outline = "none"; }, 2000);
            }
        }
    }

    function goPath(p) { currentPath = p; render(); }
    initApp();
</script>
</body>
</html>