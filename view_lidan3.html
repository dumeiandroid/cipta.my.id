<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidan Cloud - Viewer Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root { --blue: #0078d7; --bg: #f5f5f5; --border: #ddd; --card-bg: #ffffff; --text: #333; --danger: #d93025; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

        header { background: white; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .path-bar { flex: 1; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; background: #fff; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .path-bar span { cursor: pointer; color: var(--blue); font-weight: 600; }
        
        .btn-action { background: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-upload { background: var(--blue); color: white; border: none; }

        #explorerContainer { padding: 15px; max-width: 1200px; margin: 0 auto; }
        
        /* GRID SETTINGS: Desktop default auto-fill */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
        }

        /* KHUSUS HP: 2 Kolom ke Samping */
        @media (max-width: 600px) {
            .grid { 
                grid-template-columns: repeat(2, 1fr) !important; 
                gap: 10px; 
            }
            .btn-action span { display: none; } /* Sembunyikan teks tombol di HP agar hemat ruang */
            header { padding: 10px; gap: 5px; }
        }

        .item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
        .item:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--blue); }
        
        .icon-box { height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden; border-radius: 8px; background: #ececec; position: relative; }
        .icon-box img, .icon-box video { width: 100%; height: 100%; object-fit: cover; }
        .folder-icon { font-size: 50px; color: #ffca28; }
        .file-icon { font-size: 35px; color: #90a4ae; }
        
        .name { font-size: 12px; font-weight: 500; word-break: break-all; height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; margin-bottom: 8px; }

        .item-actions { display: flex; justify-content: space-around; gap: 4px; margin-top: auto; }
        .btn-small { flex: 1; padding: 6px 2px; font-size: 10px; border-radius: 4px; border: 1px solid var(--border); background: #f8f9fa; cursor: pointer; white-space: nowrap; }
        .btn-del { color: var(--danger); }

        /* Player Overlay */
        #playerOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); color: white; border: none; font-size: 24px; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 10002; display: flex; align-items: center; justify-content: center; }
        
        /* Navigasi Panah */
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.15); color: white; border: none; width: 50px; height: 70px; font-size: 24px; cursor: pointer; z-index: 10001; transition: 0.3s; display: flex; align-items: center; justify-content: center; border-radius: 8px; backdrop-filter: blur(5px); }
        .nav-btn:hover { background: rgba(255,255,255,0.4); }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }

        /* Sembunyikan panah di HP jika dirasa mengganggu (opsional), tapi di sini saya biarkan agar user mudah klik */
        @media (max-width: 768px) {
            .nav-btn { width: 40px; height: 60px; font-size: 20px; opacity: 0.7; }
        }

        .swiper { width: 100%; height: 100%; }
        .swiper-slide { display: flex; justify-content: center; align-items: center; }
        video, .player-image { max-width: 95%; max-height: 90%; object-fit: contain; }

        #uploadModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10003; justify-content:center; align-items:center; padding: 20px; }
        .modal-content { background:white; padding:25px; border-radius:12px; width:100%; max-width:350px; }
    </style>
</head>
<body>

<header>
    <button onclick="muatData()" class="btn-action">üîÑ <span>Refresh</span></button>
    <div class="path-bar" id="pathBar"></div>
    <button onclick="openUploadModal()" class="btn-action btn-upload">üì§ <span>Upload</span></button>
</header>

<main id="explorerContainer">
    <div class="grid" id="explorer"></div>
</main>

<div id="playerOverlay">
    <button class="close-btn" onclick="closePlayer()">‚úï</button>
    <button class="nav-btn prev-btn" onclick="swiperInstance.slidePrev()">‚ùÆ</button>
    <button class="nav-btn next-btn" onclick="swiperInstance.slideNext()">‚ùØ</button>
    
    <div class="swiper">
        <div class="swiper-wrapper" id="playerWrapper"></div>
    </div>
</div>

<div id="uploadModal">
    <div class="modal-content">
        <h3 style="margin-top:0">Upload ke:</h3>
        <p id="targetPathDisplay" style="font-weight:bold; color:var(--blue); word-break:break-all"></p>
        <input type="file" id="fileInput" multiple style="margin-bottom:15px; width: 100%;">
        <div style="display:flex; gap:10px">
            <button onclick="prosesUpload()" class="btn-action btn-upload" style="flex:1">Mulai</button>
            <button onclick="closeUploadModal()" class="btn-action" style="flex:1">Batal</button>
        </div>
        <div id="uploadProgress" style="margin-top:10px; font-size:12px; color:var(--blue); text-align:center"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    const API_URL = "https://lidan.co.id/api/r2_api_lidan";
    let allData = [], currentPath = "", mediaFiles = [], swiperInstance = null;

    async function muatData() {
        try {
            const res = await fetch(`${API_URL}?action=list`);
            allData = await res.json();
            render();
        } catch(e) { console.error(e); }
    }

    function render() {
        const explorer = document.getElementById('explorer');
        const pathBar = document.getElementById('pathBar');
        explorer.innerHTML = "";
        
        pathBar.innerHTML = `<span onclick="goPath('')">Root</span>`;
        let bPath = "";
        currentPath.split('/').filter(x=>x).forEach(part => {
            bPath += (bPath ? "/" : "") + part;
            const target = bPath;
            pathBar.innerHTML += ` / <span onclick="goPath('${target}')">${part}</span>`;
        });

        let folders = new Set();
        mediaFiles = [];

        allData.forEach(item => {
            if (!item.key.startsWith(currentPath)) return;
            const relativeKey = currentPath === "" ? item.key : item.key.substring(currentPath.length + 1);
            if (!relativeKey) return;
            const parts = relativeKey.split('/');
            if (parts.length > 1) folders.add(parts[0]);
            else if (parts[0] !== ".folder") mediaFiles.push(item);
        });

        // Folder Render
        Array.from(folders).sort().forEach(f => {
            const fPath = currentPath === "" ? f : currentPath + "/" + f;
            explorer.appendChild(createCard(`<span class="folder-icon">üìÅ</span>`, f, () => goPath(fPath), true));
        });

        // File Render
        mediaFiles.forEach((file, index) => {
            const ext = file.key.split('.').pop().toLowerCase();
            let icon = ['jpg','jpeg','png','gif','webp'].includes(ext) ? `<img src="${file.url}">` :
                       ['mp4','webm'].includes(ext) ? `<video src="${file.url}" muted></video>` : `<span class="file-icon">üìÑ</span>`;
            explorer.appendChild(createCard(icon, file.key.split('/').pop(), () => openPlayer(index), false, file));
        });
    }

    function createCard(icon, name, action, isFolder, fileData) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div class="icon-box">${icon}</div><div class="name">${name}</div>`;
        if (!isFolder) {
            const act = document.createElement('div');
            act.className = 'item-actions';
            act.innerHTML = `
                <button class="btn-small" onclick="event.stopPropagation(); copyLink('${fileData.url}')">Link</button>
                <button class="btn-small" onclick="event.stopPropagation(); duplicateFile('${fileData.key}')">Dup</button>
                <button class="btn-small btn-del" onclick="event.stopPropagation(); deleteFile('${fileData.key}')">üóëÔ∏è</button>
            `;
            div.appendChild(act);
        }
        div.onclick = action;
        return div;
    }

    async function duplicateFile(oldKey) {
        const nameOnly = oldKey.split('/').pop();
        const newName = prompt("Nama file duplikat:", "copy_" + nameOnly);
        if (!newName) return;

        const path = oldKey.includes('/') ? oldKey.substring(0, oldKey.lastIndexOf("/") + 1) : "";
        const newKey = path + newName;

        try {
            await fetch(`${API_URL}?action=rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
                body: JSON.stringify({ oldKey, newKey, keepOriginal: true }) 
            });
            alert("Berhasil diduplikasi!");
            muatData();
        } catch (e) { alert("Gagal menduplikasi"); }
    }

    function openPlayer(startIndex) {
        const wrapper = document.getElementById('playerWrapper');
        wrapper.innerHTML = "";
        mediaFiles.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            const ext = file.key.split('.').pop().toLowerCase();
            if (['mp4','webm'].includes(ext)) slide.innerHTML = `<video src="${file.url}" controls playsinline></video>`;
            else if (['jpg','jpeg','png','gif','webp'].includes(ext)) slide.innerHTML = `<img src="${file.url}" class="player-image">`;
            else slide.innerHTML = `<div style="color:white">üìÑ ${file.key}</div>`;
            wrapper.appendChild(slide);
        });

        document.getElementById('playerOverlay').style.display = 'flex';
        
        if (swiperInstance) swiperInstance.destroy();
        swiperInstance = new Swiper('.swiper', {
            initialSlide: startIndex,
            simulateTouch: true,
            grabCursor: true,
            keyboard: { enabled: true }
        });
    }

    function closePlayer() {
        document.getElementById('playerOverlay').style.display = 'none';
        document.querySelectorAll('video').forEach(v => v.pause());
    }

    function openUploadModal() {
        document.getElementById('targetPathDisplay').textContent = currentPath || "Root (Utama)";
        document.getElementById('uploadModal').style.display = 'flex';
    }
    function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }

    async function prosesUpload() {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return;
        const progress = document.getElementById('uploadProgress');
        for (let file of files) {
            progress.textContent = `Sedang Upload: ${file.name}`;
            const formData = new FormData();
            const fullPath = currentPath ? currentPath + "/" + file.name : file.name;
            formData.append('file', file);
            formData.append('customName', fullPath);
            await fetch(`${API_URL}?action=upload`, {
                method: 'POST',
                headers: { 'X-Custom-Auth': 'admin' },
                body: formData
            });
        }
        alert("Upload Selesai!");
        closeUploadModal();
        muatData();
    }

    function copyLink(url) {
        navigator.clipboard.writeText(url);
        alert("Link disalin!");
    }

    async function deleteFile(key) {
        if (!confirm("Hapus file?")) return;
        await fetch(`${API_URL}?action=delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
            body: JSON.stringify({ key })
        });
        muatData();
    }

    function goPath(p) { currentPath = p; render(); }
    muatData();
</script>
</body>
</html>