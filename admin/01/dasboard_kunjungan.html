<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kunjungan URL (x_01)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <style>
        /* Gaya Card Mirip AdminLTE/SB Admin */
        .border-left-primary { border-left: .25rem solid #4e73df!important; }
        .border-left-success { border-left: .25rem solid #1cc88a!important; }
        .border-left-warning { border-left: .25rem solid #f6c23e!important; } 
        .load-data-btn { cursor: pointer; text-decoration: none; }
        .load-data-btn:hover { text-decoration: underline; }

        /* MODIFIKASI: Gaya untuk Scrollbar di Detail Card */
        .card-footer.scrollable-details {
            max-height: 250px; /* Tinggi maksimum yang diizinkan */
            overflow-y: auto; /* Aktifkan scrollbar vertikal jika melebihi batas */
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <h1 class="h3 mb-4 text-gray-800">Dashboard Kunjungan URL (x_01)</h1>

        <div class="row mb-4 align-items-center">
            <div class="col-lg-5 col-md-6 mb-3 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt me-2"></i> Tanggal Filter</span>
                    <input type="date" class="form-control" id="inputTanggalFilter" max="<?php echo date('Y-m-d'); ?>">
                    <button class="btn btn-warning" id="btnLoadFilterDate"><i class="fas fa-sync-alt me-1"></i> Muat</button>
                </div>
            </div>
             <div class="col-lg-7 col-md-6 text-lg-end text-start">
                 <span class="text-muted"><small>Auto Refresh: <span id="lastUpdated">N/A</span></small></span>
            </div>
        </div>
        
        <div class="row" id="data-dashboard-container">
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Kunjungan Hari Ini (<span id="hari_ini-date-label">Memuat...</span>)
                                </div>
                                <div id="hari_ini-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-calendar-day fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white scrollable-details"> 
                        <div class="row small" id="hari_ini-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Total Kunjungan Tanggal Pilihan (<span id="tanggal_pilihan-date-label">Memuat...</span>)
                                </div>
                                <div id="tanggal_pilihan-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-calendar-check fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white scrollable-details">
                        <div class="row small" id="tanggal_pilihan-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Total Kunjungan Keseluruhan
                                </div>
                                <div id="keseluruhan-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-database fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white scrollable-details">
                        <div class="row small" id="keseluruhan-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">Detail Data Kunjungan: <span id="modal-title-url"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="dataTableDetail" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>URL (x_01)</th>
                                        <th>x_02 (Unik)</th>
                                        <th>Kunjungan (x_03)</th>
                                        <th>Waktu Update (x_19)</th>
                                        <th>Waktu Create (x_20)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    
    // --- KONSTANTA & VARIABEL ---
    const API_BASE_URL = "https://lidan-co-id.pages.dev/api/contacts_filter_dinamis";
    const TABLE_NAME = "kunjungan";
    const POLLING_INTERVAL = 5000;
    const colors = ['info', 'success', 'warning', 'danger', 'secondary', 'primary', 'dark'];

    const selectedDateInput = $('#inputTanggalFilter');
    let detailDataTableInstance = null;
    
    // --- HELPER FUNCTIONS ---
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function getTodayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function getPreviousDayDate() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1); 
        
        const year = yesterday.getFullYear();
        const month = String(yesterday.getMonth() + 1).padStart(2, '0');
        const day = String(yesterday.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function updateTimestamp() {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        $('#lastUpdated').text(`Terakhir Diperbarui: ${formattedTime}`);
    }

    async function fetchData(url) {
        // DEBUG 1: LOG URL API yang dipanggil
        console.log(`[DEBUG FETCH] Memanggil URL: ${url}`); 
        try {
            const response = await fetch(url, { method: 'GET' });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed: ${response.status} - ${response.statusText}. Response Body: ${errorBody}`);
            }
            const data = await response.json();
            return data.data || []; 
        } catch (error) {
            console.error("[DEBUG FETCH] ❌ Gagal mengambil data dari API:", error.message);
            throw error; 
        }
    }

    // Fungsi ini tetap melacak id_x_max
    function aggregateByX01(data) {
        const aggregation = {};
        let totalCount = 0; 
        
        if (!Array.isArray(data)) return { aggregation, totalCount };
        
        data.forEach(item => {
            const url = item.x_01 || 'URL Kosong';
            const visits = parseInt(item.x_02, 10) || 0; 
            const currentIdX = parseInt(item.id_x, 10) || 0; 
            
            if (aggregation[url]) {
                aggregation[url].x_02_total += visits; 
                if (currentIdX > aggregation[url].id_x_max) {
                     aggregation[url].id_x_max = currentIdX;
                }
            } else {
                aggregation[url] = { 
                    x_02_total: visits,
                    id_x_max: currentIdX 
                }; 
            }
            totalCount += visits; 
        });
        
        return { aggregation, totalCount };
    }


    // --- RENDERING FUNCTIONS ---

    async function loadDashboardData() {
        const today = getTodayDate();
        const filterDate = selectedDateInput.val(); 
        
        $('#hari_ini-date-label').text(new Intl.DateTimeFormat('id-ID').format(new Date(today)));
        $('#tanggal_pilihan-date-label').text(new Intl.DateTimeFormat('id-ID').format(new Date(filterDate)));

        const todayUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_20_like=${today}%`;
        const filterDateUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_20_like=${filterDate}%`;
        const overallUrl = `${API_BASE_URL}?table=${TABLE_NAME}`;

        const [todayRaw, filterRaw, overallRaw] = await Promise.all([
            fetchData(todayUrl).catch(e => { console.error("Error loading Today data:", e.message); return []; }),
            fetchData(filterDateUrl).catch(e => { console.error("Error loading Filter Date data:", e.message); return []; }),
            fetchData(overallUrl).catch(e => { console.error("Error loading Overall data:", e.message); return []; })
        ]);
        
        const todayAggregated = aggregateByX01(todayRaw);
        const filterAggregated = aggregateByX01(filterRaw);
        const overallAggregated = aggregateByX01(overallRaw);

        renderCard('hari_ini', todayAggregated.totalCount, todayAggregated.aggregation, today);
        renderCard('tanggal_pilihan', filterAggregated.totalCount, filterAggregated.aggregation, filterDate);
        renderCard('keseluruhan', overallAggregated.totalCount, overallAggregated.aggregation, null); 

        updateTimestamp();
    }

    function renderCard(mode, total, aggregation, dateFilter) {
        $(`#${mode}-total`).text(formatNumber(total));
        
        const detailsContainer = $(`#${mode}-details`);
        detailsContainer.html('');

        if (total === 0) {
            detailsContainer.html(`<div class="col-12 text-muted">Tidak ada data ${mode === 'hari_ini' ? 'hari ini' : mode === 'tanggal_pilihan' ? 'pada tanggal ini' : 'keseluruhan'}.</div>`);
            return;
        }

        let html = '';
        let colorIndex = 0;
        
        // LOGIKA PENGURUTAN YANG DIMODIFIKASI
        let sortedUrls;
        
        if (mode === 'hari_ini') {
            // Urutkan berdasarkan id_x_max (sesuai permintaan sebelumnya)
            sortedUrls = Object.keys(aggregation).sort((a, b) => aggregation[b].id_x_max - aggregation[a].id_x_max);
        } else {
            // Urutkan berdasarkan x_02_total (Total Kunjungan) (sesuai permintaan baru)
            sortedUrls = Object.keys(aggregation).sort((a, b) => aggregation[b].x_02_total - aggregation[a].x_02_total);
        }
        // END LOGIKA PENGURUTAN

        sortedUrls.forEach(url => {
            const count = aggregation[url].x_02_total;
            const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
            const color = colors[colorIndex % colors.length];
            
            const filterToday = mode === 'hari_ini' ? 'true' : 'false';
            const filterDateParam = dateFilter || ''; 

            const displayUrl = url.length > 35 ? url.substring(0, 32) + '...' : url;

            html += `
                <div class="col-12 mt-1">
                    <a href="#" 
                        class="load-data-btn text-xs text-secondary d-block" 
                        data-bs-toggle="modal" 
                        data-bs-target="#detailModal" 
                        data-url="${url}"
                        data-filter-today="${filterToday}" 
                        data-filter-date="${filterDateParam}"
                        title="Lihat detail untuk: ${url}">
                        <span class="text-${color} me-1">•</span> ${displayUrl}: 
                        <strong>${formatNumber(count)}</strong> (${percentage}%)
                    </a>
                </div>
            `;
            colorIndex++;
        });
        
        detailsContainer.html(html);
    }
    
    
    /**
     * Memuat data detail untuk URL tertentu ke dalam Modal DataTables
     */
    async function loadDetailData(url, filterToday, filterDate) {
        
        if (detailDataTableInstance) {
            detailDataTableInstance.destroy();
            detailDataTableInstance = null; 
            $('#dataTableDetail tbody').empty();
        }

        const emptyColspan = 6;
        $('#dataTableDetail tbody').html(`<tr><td colspan="${emptyColspan}" class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Memuat data...</p></td></tr>`);
        
        let apiUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_01_eq=${encodeURIComponent(url)}`;
        
        if (filterToday === 'true') {
            const today = getTodayDate();
            apiUrl += `&x_20_like=${today}%`;
            $('#modal-title-url').html(`${url} <span class="badge bg-primary">Hari Ini</span>`);
        } else if (filterDate) {
            apiUrl += `&x_20_like=${filterDate}%`; 
            $('#modal-title-url').html(`${url} <span class="badge bg-warning">${filterDate}</span>`);
        } else {
            $('#modal-title-url').html(`${url} <span class="badge bg-success">Keseluruhan</span>`);
        }
        
        console.log(`[DEBUG DETAIL] Final URL Detail: ${apiUrl}`); 

        try {
            const rawData = await fetchData(apiUrl);
            
            console.log("[DEBUG DETAIL] Data Mentah Diterima (Jumlah):", rawData.length);
            
            $('#dataTableDetail tbody').empty();

            if (rawData.length === 0) {
                 $('#dataTableDetail tbody').html('<tr><td colspan="' + emptyColspan + '" class="alert alert-info">Tidak ada data detail untuk filter ini.</td></tr>');
                 return;
            }
            
            if(rawData.length > 0) {
                console.log("[DEBUG DETAIL] Contoh Item Data Pertama:", rawData[0]);
            }

            detailDataTableInstance = $('#dataTableDetail').DataTable({
                data: rawData,
                columns: [
                    { data: 'id_x' },
                    { data: 'x_01' }, 
                    { data: 'x_02' },
                    { data: 'x_03' },
                    { data: 'x_19' },
                    { data: 'x_20' }
                ],
                "destroy": true, 
                "paging": true,
                "ordering": true,
                "info": true,
                "searching": true,
                "order": [[5, 'desc']] // Tetap urutkan modal detail berdasarkan Waktu Create (x_20)
            });

        } catch (error) {
            console.error("[DEBUG DETAIL] ❌ Gagal memuat detail data atau inisialisasi DataTables. Lihat error di atas.", error); 
            $('#dataTableDetail tbody').html('<tr><td colspan="' + emptyColspan + '" class="alert alert-danger">❌ Gagal memuat data. Lihat konsol browser (F12) untuk detail error.</td></tr>');
        }
    }


    // --- EVENT HANDLERS ---
    
    $('#btnLoadFilterDate').on('click', function() {
        const selectedDate = selectedDateInput.val();
        if (selectedDate) {
            loadDashboardData(); 
        } else {
            alert('Silakan pilih tanggal terlebih dahulu.');
        }
    });

    $('#data-dashboard-container').on('click', '.load-data-btn', function(event) {
        event.preventDefault();
        const btn = $(this);
        const url = btn.data('url');
        const filterToday = btn.data('filter-today');
        const filterDate = btn.data('filter-date');
        
        loadDetailData(url, filterToday, filterDate);
    });
    
    // --- INIT ---
    selectedDateInput.val(getPreviousDayDate());
    loadDashboardData(); 

    setInterval(function() {
        loadDashboardData();
    }, POLLING_INTERVAL);
});
</script>
</body>
</html>