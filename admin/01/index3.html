<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kunjungan URL (x_01)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <style>
        /* Gaya Card Mirip AdminLTE/SB Admin */
        .border-left-primary { border-left: .25rem solid #4e73df!important; }
        .border-left-success { border-left: .25rem solid #1cc88a!important; }
        .border-left-warning { border-left: .25rem solid #f6c23e!important; } 
        .load-data-btn { cursor: pointer; text-decoration: none; }
        .load-data-btn:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <h1 class="h3 mb-4 text-gray-800">Dashboard Kunjungan URL (x_01)</h1>

        <div class="row mb-4 align-items-center">
            <div class="col-lg-5 col-md-6 mb-3 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt me-2"></i> Tanggal Filter</span>
                    <input type="date" class="form-control" id="inputTanggalFilter" max="<?php echo date('Y-m-d'); ?>">
                    <button class="btn btn-warning" id="btnLoadFilterDate"><i class="fas fa-sync-alt me-1"></i> Muat</button>
                </div>
            </div>
             <div class="col-lg-7 col-md-6 text-lg-end text-start">
                 <span class="text-muted"><small>Auto Refresh: <span id="lastUpdated">N/A</span></small></span>
            </div>
        </div>
        
        <div class="row" id="data-dashboard-container">
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Total Kunjungan Hari Ini (<span id="hari_ini-date-label">Memuat...</span>)
                                </div>
                                <div id="hari_ini-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-calendar-day fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white">
                        <div class="row small" id="hari_ini-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    Total Kunjungan Tanggal Pilihan (<span id="tanggal_pilihan-date-label">Memuat...</span>)
                                </div>
                                <div id="tanggal_pilihan-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-calendar-check fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white">
                        <div class="row small" id="tanggal_pilihan-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Total Kunjungan Keseluruhan
                                </div>
                                <div id="keseluruhan-total" class="h5 mb-0 font-weight-bold text-gray-800">0</div>
                            </div>
                            <div class="col-auto"><i class="fas fa-database fa-2x text-gray-300"></i></div>
                        </div>
                    </div>
                    <div class="card-footer py-2 bg-white">
                        <div class="row small" id="keseluruhan-details">
                            <div class="col-12 text-muted">Memuat detail URL...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">Detail Data Kunjungan: <span id="modal-title-url"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="dataTableDetail" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>URL (x_01)</th>
                                        <th>x_02 (Unik)</th>
                                        <th>Kunjungan (x_03)</th>
                                        <th>Waktu Update (x_19)</th>
                                        <th>Waktu Create (x_20)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    
    // --- KONSTANTA & VARIABEL ---
    const API_BASE_URL = "https://lidan-co-id.pages.dev/api/contacts";
    const TABLE_NAME = "kunjungan";
    const POLLING_INTERVAL = 5000;
    const colors = ['info', 'success', 'warning', 'danger', 'secondary', 'primary', 'dark'];

    const selectedDateInput = $('#inputTanggalFilter');
    let detailDataTableInstance = null;
    
    // --- HELPER FUNCTIONS ---
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function getTodayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function updateTimestamp() {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        $('#lastUpdated').text(`Terakhir Diperbarui: ${formattedTime}`);
    }

    async function fetchData(url) {
        try {
            const response = await fetch(url, { method: 'GET' });
            if (!response.ok) {
                throw new Error(`API call failed: ${response.status}`);
            }
            const data = await response.json();
            return data.data || []; 
        } catch (error) {
            console.error("Gagal mengambil data dari API:", error.message);
            return [];
        }
    }

    /**
     * FUNGSI KUNCI: Melakukan Grouping dan Aggregation di Front-End
     * Menjumlahkan kolom x_02 (Kunjungan Unik Harian) per group x_01.
     */
    function aggregateByX01(data) {
        const aggregation = {};
        let totalCount = 0; 
        
        if (!Array.isArray(data)) return { aggregation, totalCount };
        
        data.forEach(item => {
            const url = item.x_01 || 'URL Kosong';
            // Menjumlahkan x_02 (yang seharusnya bernilai 1 untuk setiap baris unik harian)
            const visits = parseInt(item.x_02, 10) || 0; 

            if (aggregation[url]) {
                aggregation[url].x_02_total += visits; 
            } else {
                aggregation[url] = { x_02_total: visits }; 
            }
            totalCount += visits; 
        });
        
        return { aggregation, totalCount };
    }


    // --- RENDERING FUNCTIONS ---

    /**
     * Memuat dan merender semua data di tiga card utama.
     */
    async function loadDashboardData() {
        // Ambil nilai tanggal hari ini dan tanggal filter saat ini
        const today = getTodayDate();
        const filterDate = selectedDateInput.val(); 
        
        // 1. Labeling
        $('#hari_ini-date-label').text(new Intl.DateTimeFormat('id-ID').format(new Date(today)));
        $('#tanggal_pilihan-date-label').text(new Intl.DateTimeFormat('id-ID').format(new Date(filterDate)));

        // 2. Tentukan URL Fetch
        
        // Hari Ini: Filter berdasarkan x_20 (Waktu Create)
        const todayUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_20_like=${today}%`;
        
        // Tanggal Pilihan: Filter berdasarkan x_19 (Waktu Update/Create) dan TANGGAL PILIHAN
        const filterDateUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_19_like=${filterDate}%`;
        
        // Keseluruhan: TIDAK ADA FILTER TANGGAL. Selalu mengambil seluruh data.
        const overallUrl = `${API_BASE_URL}?table=${TABLE_NAME}`;

        // 3. Fetch data secara simultan
        const [todayRaw, filterRaw, overallRaw] = await Promise.all([
            fetchData(todayUrl),
            fetchData(filterDateUrl),
            fetchData(overallUrl)
        ]);
        
        // 4. Agregasi
        const todayAggregated = aggregateByX01(todayRaw);
        const filterAggregated = aggregateByX01(filterRaw);
        const overallAggregated = aggregateByX01(overallRaw);

        // 5. Render ke UI
        
        renderCard('hari_ini', todayAggregated.totalCount, todayAggregated.aggregation, today);
        renderCard('tanggal_pilihan', filterAggregated.totalCount, filterAggregated.aggregation, filterDate);
        renderCard('keseluruhan', overallAggregated.totalCount, overallAggregated.aggregation, null); 

        updateTimestamp();
    }

    /**
     * Fungsi untuk merender detail URL ke dalam card footer.
     */
    function renderCard(mode, total, aggregation, dateFilter) {
        $(`#${mode}-total`).text(formatNumber(total));
        
        const detailsContainer = $(`#${mode}-details`);
        detailsContainer.html('');

        if (total === 0) {
            detailsContainer.html(`<div class="col-12 text-muted">Tidak ada data ${mode === 'hari_ini' ? 'hari ini' : mode === 'tanggal_pilihan' ? 'pada tanggal ini' : 'keseluruhan'}.</div>`);
            return;
        }

        let html = '';
        let colorIndex = 0;
        
        // PERBAIKAN: Sorting harus menggunakan x_02_total, bukan x_03_total
        const sortedUrls = Object.keys(aggregation).sort((a, b) => aggregation[b].x_02_total - aggregation[a].x_02_total);

        sortedUrls.forEach(url => {
            // MENGGUNAKAN x_02_total
            const count = aggregation[url].x_02_total;
            const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
            const color = colors[colorIndex % colors.length];
            
            const filterToday = mode === 'hari_ini' ? 'true' : 'false';
            const filterDateParam = dateFilter || ''; 

            const displayUrl = url.length > 35 ? url.substring(0, 32) + '...' : url;

            html += `
                <div class="col-12 mt-1">
                    <a href="#" 
                        class="load-data-btn text-xs text-secondary d-block" 
                        data-bs-toggle="modal" 
                        data-bs-target="#detailModal" 
                        data-url="${url}"
                        data-filter-today="${filterToday}" 
                        data-filter-date="${filterDateParam}"
                        title="Lihat detail untuk: ${url}">
                        <span class="text-${color} me-1">â€¢</span> ${displayUrl}: 
                        <strong>${formatNumber(count)}</strong> (${percentage}%)
                    </a>
                </div>
            `;
            colorIndex++;
        });
        
        detailsContainer.html(html);
    }
    
    
    /**
     * Memuat data detail untuk URL tertentu ke dalam Modal DataTables
     */
    async function loadDetailData(url, filterToday, filterDate) {
        
        if (detailDataTableInstance) {
            detailDataTableInstance.destroy();
            $('#dataTableDetail tbody').empty();
        }

        const emptyColspan = 6;
        $('#dataTableDetail tbody').html(`<tr><td colspan="${emptyColspan}" class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Memuat data...</p></td></tr>`);
        
        let apiUrl = `${API_BASE_URL}?table=${TABLE_NAME}&x_01_eq=${encodeURIComponent(url)}`;
        
        if (filterToday === 'true') {
            const today = getTodayDate();
            // Filter Hari Ini menggunakan x_20
            apiUrl += `&x_20_like=${today}%`;
            $('#modal-title-url').html(`${url} <span class="badge bg-primary">Hari Ini</span>`);
        } else if (filterDate) {
            // Filter Tanggal Pilihan menggunakan x_19
            apiUrl += `&x_19_like=${filterDate}%`; 
            $('#modal-title-url').html(`${url} <span class="badge bg-warning">${filterDate}</span>`);
        } else {
            $('#modal-title-url').html(`${url} <span class="badge bg-success">Keseluruhan</span>`);
        }

        try {
            const rawData = await fetchData(apiUrl);
            
            $('#dataTableDetail tbody').empty();

            if (rawData.length === 0) {
                 $('#dataTableDetail tbody').html('<tr><td colspan="' + emptyColspan + '" class="alert alert-info">Tidak ada data detail untuk filter ini.</td></tr>');
                 return;
            }

            detailDataTableInstance = $('#dataTableDetail').DataTable({
                data: rawData,
                columns: [
                    { data: 'id_x' },
                    { data: 'x_01', render: $.fn.dataTable.render.ellipsis(40) }, 
                    { data: 'x_02' },
                    { data: 'x_03' },
                    { data: 'x_19' },
                    { data: 'x_20' }
                ],
                "destroy": true, 
                "paging": true,
                "ordering": true,
                "info": true,
                "searching": true,
                "order": [[4, 'desc']]
            });

        } catch (error) {
            console.error("Gagal memuat detail data:", error);
            $('#dataTableDetail tbody').html('<tr><td colspan="' + emptyColspan + '" class="alert alert-danger">Gagal memuat data dari server.</td></tr>');
        }
    }


    // --- EVENT HANDLERS ---
    
    // Event listener untuk tombol Muat Data Tanggal Pilihan
    $('#btnLoadFilterDate').on('click', function() {
        const selectedDate = selectedDateInput.val();
        if (selectedDate) {
            loadDashboardData(); 
        } else {
            alert('Silakan pilih tanggal terlebih dahulu.');
        }
    });

    // Delegated Event Handler untuk tombol detail di Card Footer
    $('#data-dashboard-container').on('click', '.load-data-btn', function(event) {
        event.preventDefault();
        const btn = $(this);
        const url = btn.data('url');
        const filterToday = btn.data('filter-today');
        const filterDate = btn.data('filter-date');
        
        loadDetailData(url, filterToday, filterDate);
    });
    
    // --- INIT ---
    // Atur tanggal default ke hari ini
    selectedDateInput.val(getTodayDate());
    loadDashboardData(); 

    // Auto refresh
    setInterval(function() {
        loadDashboardData();
    }, POLLING_INTERVAL);
});
</script>
</body>
</html>