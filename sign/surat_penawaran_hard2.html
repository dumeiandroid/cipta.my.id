<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Penawaran Resmi - Lidan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap');
        body { background-color: #f3f4f6; font-family: 'Times New Roman', Times, serif; }
        .paper {
            width: 210mm; min-height: 297mm; padding: 10mm 25mm 25mm 25mm; 
            margin: 20px auto; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative; page-break-after: always;
        }
        .paper:last-child { page-break-after: auto; }
        .line-header { border-bottom: 3px solid #BF1A54; margin-top: 10px; }
        .line-header-thin { border-bottom: 1px solid #BF1A54; margin-top: 2px; }
        @media print {
            body { background: none; padding: 0; }
            .paper { margin: 0; box-shadow: none; width: 100%; }
            .no-print { display: none; }
        }
        .content-text { line-height: 1.6; text-align: justify; font-size: 12pt; }
        .qr-area { width: 120px; height: 120px; }
        .btn-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body>

    <script>
        const DOC_CONFIG = {
            "api": {
                "baseUrl": "https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6",
                "tableName": "surat_penawaran",
                "authKey": "admin", // HAPUS NILAI INI SAAT UPLOAD (Kosongkan saja: "")
                "viewRole": "user"   // Role default untuk melihat surat (non-admin)
            },
            "company": {
                "name": "PT Lidan Indah Abadi",
                "logo": "https://lidan.co.id/gambar/logo-baru.png",
                "address": "Jl. Imam Bonjol No. 9, Regus Forum Nine Lt.9 , Medan, Sumatera Utara",
                "contact": "Email: info@lidan.co.id | Website: lidan.co.id | Whatsapp: 0851 5960 1400",
                "color": "#BF1A54"
            },
            "content": {
                "opening": "Dengan hormat,",
                "paragraph1": "Sehubungan dengan adanya kebutuhan pengembangan sumber daya manusia dan peningkatan efektivitas kerja, kami dari <strong>{companyName}</strong> bermaksud mengajukan penawaran kerjasama terkait <em>{perihal}</em>.",
                "paragraph2": "Sebagai perusahaan yang bergerak di bidang penyediaan jasa profesional, kami memiliki pengalaman dan kompetensi yang telah terbukti dalam melayani berbagai institusi dan perusahaan terkemuka.",
                "paragraph3": "Program yang kami tawarkan dirancang secara komprehensif dengan mengacu pada standar industri terkini dan disesuaikan dengan kebutuhan spesifik organisasi Bapak/Ibu.",
                "paragraph4": "Tim profesional kami terdiri dari tenaga ahli bersertifikat dan berpengalaman yang siap memberikan layanan terbaik dengan pendekatan yang aplikatif dan terukur.",
                "paragraph5": "Besar harapan kami agar penawaran ini dapat memberikan kontribusi positif bagi instansi Bapak/Ibu. Detail teknis dan biaya terkait penawaran ini kami lampirkan bersama dengan surat ini.",
                "closing": "Demikian surat penawaran ini kami sampaikan. Atas perhatian dan kerjasama Bapak/Ibu, kami ucapkan terima kasih.",
                "regards": "Hormat kami,",
                "footerNote": "Surat ini sah dan diterbitkan secara elektronik melalui sistem verifikasi Lidan."
            },
            "verificationUrl": "https://lidan.co.id/sign/surat_penawaran"
        };
    </script>

    <div class="no-print btn-container flex gap-2">
        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-700 transition">Cetak / Print</button>
        <button onclick="downloadPDF()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition">Download PDF (A4)</button>
    </div>

    <div id="multi-page-content">
        <div class="paper page-1" id="page-1">
            <div class="header-section"></div> <div id="loading" class="text-center py-20">
                <p class="animate-pulse font-bold text-gray-400">Menyusun Dokumen...</p>
            </div>
            <div id="surat-isi-1" class="hidden mt-4">
                <div class="flex justify-between mb-8">
                    <div class="space-y-1">
                        <table>
                            <tr><td class="w-24">Nomor</td><td>: <span id="nomor-1" class="font-bold"></span></td></tr>
                            <tr><td>Lampiran</td><td>: <span id="lampiran-1"></span></td></tr>
                            <tr><td>Perihal</td><td>: <span id="perihal-1" class="font-bold underline"></span></td></tr>
                        </table>
                    </div>
                    <div id="tanggal-1" class="text-right"></div>
                </div>
                <div class="mb-10">
                    <p>Kepada Yth,</p>
                    <p id="penerima-1" class="font-bold uppercase mt-1"></p>
                    <p id="instansi-1" class="font-bold"></p>
                    <p>Di Tempat</p>
                </div>
                <div id="body-text-1" class="content-text space-y-4"></div>
            </div>
        </div>

        <div class="paper page-2" id="page-2">
            <div class="header-section"></div> <div id="surat-isi-2" class="hidden mt-4">
                <div id="body-text-2" class="content-text space-y-4"></div>
                <div class="mt-16 flex justify-end">
                    <div class="text-center">
                        <p id="ui-regards"></p>
                        <p id="ui-company-name-sign" class="font-bold"></p>
                        <div class="flex justify-center my-4">
                            <div id="qrcode-2" class="qr-area p-2 border border-gray-100 shadow-sm"></div>
                        </div>
                        <p id="nama-penanda-2" class="font-bold underline uppercase"></p>
                        <p id="jabatan-penanda-2" class="text-sm italic"></p>
                        <p class="text-[8pt] text-gray-400 mt-2">Verified Digital Signature</p>
                    </div>
                </div>
                <div class="absolute bottom-10 left-10 right-10 flex justify-between items-end border-t pt-2 text-[9pt] text-gray-400 italic">
                    <p id="ui-footer-note"></p>
                    <p id="token-footer-2"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Fungsi Membangun Header dari JSON
        function buildHeaders() {
            const headers = document.querySelectorAll('.header-section');
            headers.forEach(h => {
                h.innerHTML = `
                    <div class="flex items-center gap-4 mb-0">
                        <img src="${DOC_CONFIG.company.logo}" alt="Logo" class="w-24 h-auto object-contain">
                        <div class="flex-1 text-center">
                            <h1 style="color: ${DOC_CONFIG.company.color};" class="text-3xl font-bold uppercase tracking-widest">${DOC_CONFIG.company.name}</h1>
                            <p class="text-sm">${DOC_CONFIG.company.address}</p>
                            <p class="text-sm italic text-gray-600">${DOC_CONFIG.company.contact}</p>
                        </div>
                    </div>
                    <div class="line-header" style="background-color: ${DOC_CONFIG.company.color};"></div>
                    <div class="line-header-thin" style="background-color: ${DOC_CONFIG.company.color};"></div>
                `;
            });
        }

        async function fetchSurat() {
            buildHeaders();
            if(!token) {
                document.getElementById('loading').innerHTML = "<span class='text-red-500 text-center font-bold'>Error: Token Tidak Ditemukan.</span>";
                return;
            }

            try {
                // MODIFIKASI: Header menyertakan X-Custom-Auth dan X-Role secara terpisah
                const res = await fetch(`${DOC_CONFIG.api.baseUrl}?table=${DOC_CONFIG.api.tableName}&x_10_eq=${token}`, {
                    headers: { 
                        'X-Custom-Auth': DOC_CONFIG.api.authKey, // Key Akses API
                        'X-Role': DOC_CONFIG.api.viewRole      // Identitas Role
                    }
                });
                const result = await res.json();
                if(result.success && result.data.length > 0) {
                    renderSurat(result.data[0]);
                } else {
                    document.getElementById('loading').innerHTML = "<span class='text-red-500'>Error: Data Tidak Valid.</span>";
                }
            } catch (e) { console.error(e); }
        }

        // ... (fungsi renderSurat dan downloadPDF tetap sama) ...
        function renderSurat(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('surat-isi-1').classList.remove('hidden');
            document.getElementById('surat-isi-2').classList.remove('hidden');

            document.getElementById('nomor-1').innerText = data.x_05 || '-';
            document.getElementById('lampiran-1').innerText = data.x_08 || '-';
            document.getElementById('perihal-1').innerText = data.x_06 || '-';
            document.getElementById('tanggal-1').innerText = data.x_07 || '';
            document.getElementById('penerima-1').innerText = data.x_03 || '-';
            document.getElementById('instansi-1').innerText = data.x_04 || '-';
            document.getElementById('nama-penanda-2').innerText = data.x_01 || '-';
            document.getElementById('jabatan-penanda-2').innerText = data.x_02 || '-';
            document.getElementById('token-footer-2').innerText = 'ID: ' + data.x_10;
            
            document.getElementById('ui-regards').innerText = DOC_CONFIG.content.regards;
            document.getElementById('ui-company-name-sign').innerText = DOC_CONFIG.company.name;
            document.getElementById('ui-footer-note').innerText = DOC_CONFIG.content.footerNote;

            const p1 = DOC_CONFIG.content.paragraph1
                        .replace('{companyName}', DOC_CONFIG.company.name)
                        .replace('{perihal}', data.x_06);

            document.getElementById('body-text-1').innerHTML = `
                <p>${DOC_CONFIG.content.opening}</p>
                <p>${p1}</p>
                <p>${DOC_CONFIG.content.paragraph2}</p>
                <p>${DOC_CONFIG.content.paragraph3}</p>
                <p>${DOC_CONFIG.content.paragraph4}</p>
            `;

            document.getElementById('body-text-2').innerHTML = `
                <p>${DOC_CONFIG.content.paragraph5}</p>
                <p>${DOC_CONFIG.content.closing}</p>
            `;

            new QRCode(document.getElementById('qrcode-2'), {
                text: `${DOC_CONFIG.verificationUrl}?token=${data.x_10}`,
                width: 120, height: 120, colorDark : "#000000", correctLevel : 3
            });
        }

        async function downloadPDF() {
            const nomorSurat = document.getElementById('nomor-1').innerText.replace(/\//g, '_');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pages = [document.getElementById('page-1'), document.getElementById('page-2')];
            for (let i = 0; i < pages.length; i++) {
                const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                if (i > 0) pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            }
            pdf.save(`Surat_${nomorSurat}.pdf`);
        }

        fetchSurat();
    </script>
</body>
</html>