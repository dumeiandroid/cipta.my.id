<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidan Cloud - Viewer Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root { --blue: #0078d7; --bg: #f5f5f5; --border: #ddd; --card-bg: #ffffff; --text: #333; --danger: #d93025; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }
        header { background: white; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .path-bar { flex: 1; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; background: #fff; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .path-bar span { cursor: pointer; color: var(--blue); font-weight: 600; }
        .btn-action { background: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .btn-upload { background: var(--blue); color: white; border: none; }
        #explorerContainer { padding: 15px; max-width: 1200px; margin: 0 auto; min-height: 80vh; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; } }
        .item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; height: 100%; }
        .icon-box { height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden; border-radius: 8px; background: #ececec; }
        .icon-box img, .icon-box video { width: 100%; height: 100%; object-fit: cover; }
        .folder-icon { font-size: 50px; color: #ffca28; }
        .name { font-size: 12px; font-weight: 500; word-break: break-all; height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; margin-bottom: 8px; }
        .item-actions { display: flex; justify-content: space-around; gap: 4px; margin-top: auto; }
        .btn-small { flex: 1; padding: 6px 2px; font-size: 10px; border-radius: 4px; border: 1px solid var(--border); background: #f8f9fa; cursor: pointer; }
        #playerOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        #uploadModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10003; justify-content:center; align-items:center; padding: 20px; }
        .modal-content { background:white; padding:25px; border-radius:12px; width:100%; max-width:350px; }
    </style>
</head>
<body>

<header>
    <button onclick="muatData()" class="btn-action">üîÑ <span>Refresh</span></button>
    <div class="path-bar" id="pathBar"></div>
    <button onclick="openUploadModal()" class="btn-action btn-upload">üì§ <span>Upload</span></button>
</header>

<main id="explorerContainer">
    <div class="grid" id="explorer"></div>
</main>

<div id="playerOverlay">
    <button style="position:absolute; top:20px; right:20px; z-index:10002; color:white; background:none; border:none; font-size:30px; cursor:pointer;" onclick="closePlayer()">‚úï</button>
    <div class="swiper">
        <div class="swiper-wrapper" id="playerWrapper"></div>
    </div>
</div>

<div id="uploadModal">
    <div class="modal-content">
        <h3>Upload ke: <span id="targetPathDisplay"></span></h3>
        <input type="file" id="fileInput" multiple>
        <button onclick="prosesUpload()" class="btn-upload" style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; color:white; cursor:pointer;">Mulai Upload</button>
        <button onclick="closeUploadModal()" style="width:100%; margin-top:5px; cursor:pointer;">Batal</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    // URL API DISESUAIKAN DENGAN FILE TERBARU ANDA
    const API_URL = "https://lidan.co.id/api/r2_api_lidan";
    
    // DAFTAR FOLDER MANUAL UNTUK TAMPILAN AWAL (ROOT)
    const MANUAL_FOLDERS = ["book", "cipta", "edukasi", "gambar", "info"];
    
    let allData = [], currentPath = "", mediaFiles = [], swiperInstance = null;

    async function muatData() {
        try {
            // Menggunakan prefix agar folder edukasi dll tidak hilang jika data > 1000
            const res = await fetch(`${API_URL}?action=list&prefix=${encodeURIComponent(currentPath)}`);
            allData = await res.json();
            render();
        } catch(e) { console.error("API Error:", e); }
    }

    function render() {
        const explorer = document.getElementById('explorer');
        const pathBar = document.getElementById('pathBar');
        explorer.innerHTML = "";

        // Breadcrumbs
        pathBar.innerHTML = `<span onclick="goPath('')">Root</span>`;
        let bPath = "";
        currentPath.split('/').filter(x=>x).forEach(part => {
            bPath += (bPath ? "/" : "") + part;
            const target = bPath;
            pathBar.innerHTML += ` / <span onclick="goPath('${target}')">${part}</span>`;
        });

        let folders = new Set();
        mediaFiles = [];

        // JIKA DI ROOT: Tambahkan folder manual agar 5 folder tersebut selalu muncul
        if (currentPath === "") {
            MANUAL_FOLDERS.forEach(f => folders.add(f));
        }

        allData.forEach(item => {
            // Filter agar hanya item di folder saat ini yang diproses
            if (currentPath !== "" && !item.key.startsWith(currentPath + "/")) return;
            
            const rel = currentPath === "" ? item.key : item.key.substring(currentPath.length + 1);
            if (!rel) return;

            const parts = rel.split('/').filter(x => x);
            if (parts.length > 1) {
                folders.add(parts[0]);
            } else if (parts.length === 1 && parts[0] !== ".folder") {
                mediaFiles.push(item);
            }
        });

        // Render Folder
        Array.from(folders).sort().forEach(f => {
            const fPath = currentPath === "" ? f : currentPath + "/" + f;
            explorer.appendChild(createCard(`<span class="folder-icon">üìÅ</span>`, f, () => goPath(fPath), true));
        });

        // Render File
        mediaFiles.forEach((file, index) => {
            const filename = file.key.split('/').pop();
            const ext = filename.split('.').pop().toLowerCase();
            let icon = ['jpg','jpeg','png','gif','webp'].includes(ext) ? `<img src="${file.url}" loading="lazy">` : 
                       ['mp4','webm'].includes(ext) ? `<video src="${file.url}" muted></video>` : `üìÑ`;
            
            explorer.appendChild(createCard(icon, filename, () => openPlayer(index), false, file));
        });
    }

    function createCard(icon, name, action, isFolder, fileData) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div class="icon-box">${icon}</div><div class="name">${name}</div>`;
        if (!isFolder) {
            const act = document.createElement('div');
            act.className = 'item-actions';
            act.innerHTML = `
                <button class="btn-small" onclick="event.stopPropagation(); copyLink('${fileData.url}')">Link</button>
                <button class="btn-small btn-del" onclick="event.stopPropagation(); deleteFile('${fileData.key}')">üóëÔ∏è</button>
            `;
            div.appendChild(act);
        }
        div.onclick = action;
        return div;
    }

    function goPath(p) { currentPath = p; muatData(); }
    function openUploadModal() { 
        document.getElementById('targetPathDisplay').innerText = currentPath || "Root";
        document.getElementById('uploadModal').style.display = 'flex'; 
    }
    function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }

    // Fungsi Player, Upload, Delete, Copy tetap menggunakan logika dari view_lidan.html asli Anda
    async function prosesUpload() {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return;
        for (let file of files) {
            const formData = new FormData();
            const fullPath = currentPath ? currentPath + "/" + file.name : file.name;
            formData.append('file', file);
            formData.append('customName', fullPath);
            await fetch(`${API_URL}?action=upload`, { method: 'POST', headers: { 'X-Custom-Auth': 'admin' }, body: formData });
        }
        alert("Upload Selesai");
        closeUploadModal();
        muatData();
    }

    function copyLink(url) { navigator.clipboard.writeText(url); alert("Link disalin!"); }

    async function deleteFile(key) {
        if (!confirm("Hapus file?")) return;
        await fetch(`${API_URL}?action=delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
            body: JSON.stringify({ key })
        });
        muatData();
    }

    function openPlayer(index) {
        const wrapper = document.getElementById('playerWrapper');
        wrapper.innerHTML = "";
        mediaFiles.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            const ext = file.key.split('.').pop().toLowerCase();
            slide.innerHTML = ['mp4','webm'].includes(ext) ? `<video src="${file.url}" controls autoplay></video>` : `<img src="${file.url}" style="max-width:100%">`;
            wrapper.appendChild(slide);
        });
        document.getElementById('playerOverlay').style.display = 'flex';
        if(swiperInstance) swiperInstance.destroy();
        swiperInstance = new Swiper('.swiper', { initialSlide: index });
    }
    
    function closePlayer() { 
        document.getElementById('playerOverlay').style.display = 'none'; 
        document.querySelectorAll('video').forEach(v => v.pause());
    }

    muatData();
</script>
</body>
</html>