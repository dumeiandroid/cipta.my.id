<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lidan Cloud - Viewer Pro (Dynamic Tree)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root { --blue: #0078d7; --bg: #f5f5f5; --border: #ddd; --card-bg: #ffffff; --text: #333; --danger: #d93025; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }
        header { background: white; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .path-bar { flex: 1; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; background: #fff; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .path-bar span { cursor: pointer; color: var(--blue); font-weight: 600; }
        .btn-action { background: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .btn-upload { background: var(--blue); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; display: none; }
        
        #explorerContainer { padding: 15px; max-width: 1200px; margin: 0 auto; min-height: 80vh; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        @media (max-width: 600px) { 
            .grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; } 
            .btn-action span { display: none; }
        }

        .item { background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; height: 100%; }
        .item:hover { border-color: var(--blue); }
        .item.selected { border: 2px solid var(--blue); background: #eef7ff; }
        
        /* Checkbox Box - Dibuat area khusus agar klik tidak memicu player */
        .checkbox-container { position: absolute; top: 0; left: 0; padding: 10px; z-index: 20; }
        .select-checkbox { width: 20px; height: 20px; cursor: pointer; }

        .icon-box { height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden; border-radius: 8px; background: #ececec; pointer-events: none; }
        .icon-box img, .icon-box video { width: 100%; height: 100%; object-fit: cover; }
        .folder-icon { font-size: 50px; color: #ffca28; }
        .name { font-size: 12px; font-weight: 500; word-break: break-all; height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4; margin-bottom: 8px; }
        
        .item-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: auto; z-index: 20; }
        .btn-small { padding: 6px 2px; font-size: 10px; border-radius: 4px; border: 1px solid var(--border); background: #f8f9fa; cursor: pointer; text-align: center; }
        .btn-del { color: var(--danger); }

        #playerOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); color: white; border: none; font-size: 24px; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; z-index: 10002; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.15); color: white; border: none; width: 50px; height: 70px; font-size: 24px; cursor: pointer; z-index: 10001; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }
        .swiper { width: 100%; height: 100%; }
        .swiper-slide { display: flex; justify-content: center; align-items: center; }
        video, .player-image { max-width: 95%; max-height: 90%; object-fit: contain; }

        #uploadModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10003; justify-content:center; align-items:center; padding: 20px; }
        .modal-content { background:white; padding:25px; border-radius:12px; width:100%; max-width:350px; }
    </style>
</head>
<body>

<header>
    <button onclick="muatData()" class="btn-action">üîÑ <span>Refresh</span></button>
    <div class="path-bar" id="pathBar"></div>
    <button id="btnBulkDelete" onclick="hapusTerpilih()" class="btn-action btn-danger">üóëÔ∏è <span>Hapus (<span id="countSelected">0</span>)</span></button>
    <button onclick="openUploadModal()" class="btn-action btn-upload">üì§ <span>Upload</span></button>
</header>

<main id="explorerContainer">
    <div class="grid" id="explorer"></div>
</main>

<div id="playerOverlay">
    <button class="close-btn" onclick="closePlayer()">‚úï</button>
    <button class="nav-btn prev-btn" onclick="swiperInstance.slidePrev()">‚ùÆ</button>
    <button class="nav-btn next-btn" onclick="swiperInstance.slideNext()">‚ùØ</button>
    <div class="swiper">
        <div class="swiper-wrapper" id="playerWrapper"></div>
    </div>
</div>

<div id="uploadModal">
    <div class="modal-content">
        <h3>Upload ke: <span id="targetPathDisplay"></span></h3>
        <input type="file" id="fileInput" multiple style="width:100%; margin-bottom:10px;">
        <button onclick="prosesUpload()" class="btn-upload" style="width:100%; padding:10px; border-radius:8px; border:none; color:white; cursor:pointer;">Mulai Upload</button>
        <button onclick="closeUploadModal()" style="width:100%; margin-top:5px; cursor:pointer; background:none; border:none; color:var(--text);">Batal</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    const API_URL = "https://lidan.co.id/api/r2_api_lidan";
    
    const FOLDER_STRUCTURE = {
        "book": {
            "finish": { "kerja": {}, "sma": {} },
            "gambar": { "kerja": {}, "mahasiswa": {}, "sma": {} }
        },
        "cipta": {
            "admin1": { "gambar": {} },
            "gambar": { "gambar1": {}, "natal": {}, "og": {}, "tes": {}, "tes1": {} },
            "gambar_tes": {"apm": {}, "cfit": {}, "ist": {}},
            "og": { "gambar": {} }
        },
        "edukasi": { "gambar": {} },
        "gambar": {},
        "psikotes-karyawan": {},
        "info": { "gambar": {}, "gambar1": {} }
    };
    
    let allData = [], currentPath = "", mediaFiles = [], swiperInstance = null;
    let selectedFiles = new Set();

    async function muatData() {
        try {
            selectedFiles.clear();
            updateBulkDeleteUI();
            const res = await fetch(`${API_URL}?action=list&prefix=${encodeURIComponent(currentPath)}`);
            allData = await res.json();
            render();
        } catch(e) { console.error("API Error:", e); }
    }

    function getFoldersFromTree(path) {
        if (!path) return Object.keys(FOLDER_STRUCTURE);
        const parts = path.split('/');
        let current = FOLDER_STRUCTURE;
        for (let part of parts) {
            if (current[part]) current = current[part];
            else return [];
        }
        return Object.keys(current);
    }

    function render() {
        const explorer = document.getElementById('explorer');
        const pathBar = document.getElementById('pathBar');
        explorer.innerHTML = "";

        pathBar.innerHTML = `<span onclick="goPath('')">Root</span>`;
        let bPath = "";
        currentPath.split('/').filter(x=>x).forEach(part => {
            bPath += (bPath ? "/" : "") + part;
            const target = bPath;
            pathBar.innerHTML += ` / <span onclick="goPath('${target}')">${part}</span>`;
        });

        let folderSet = new Set();
        mediaFiles = [];

        const manualSubFolders = getFoldersFromTree(currentPath);
        manualSubFolders.forEach(f => folderSet.add(f));

        allData.forEach(item => {
            const rel = currentPath === "" ? item.key : item.key.substring(currentPath.length + 1);
            if (!rel) return;
            const parts = rel.split('/').filter(x => x);
            if (parts.length > 1) folderSet.add(parts[0]);
            else if (parts.length === 1 && !item.key.endsWith('/')) mediaFiles.push(item);
        });

        Array.from(folderSet).sort().forEach(f => {
            const fPath = currentPath === "" ? f : currentPath + "/" + f;
            explorer.appendChild(createCard(`<span class="folder-icon">üìÅ</span>`, f, () => goPath(fPath), true));
        });

        mediaFiles.forEach((file, index) => {
            const filename = file.key.split('/').pop();
            const ext = filename.split('.').pop().toLowerCase();
            let icon = ['jpg','jpeg','png','gif','webp'].includes(ext) ? `<img src="${file.url}" loading="lazy">` : 
                       ['mp4','webm'].includes(ext) ? `<video src="${file.url}" muted></video>` : `üìÑ`;
            
            const card = createCard(icon, filename, () => openPlayer(index), false, file);
            card.id = `card-${index}`;
            explorer.appendChild(card);
        });
    }

    function createCard(icon, name, action, isFolder, fileData) {
        const div = document.createElement('div');
        div.className = 'item';
        
        let htmlContent = ``;
        if (!isFolder) {
            // Ditambahkan stopPropagation pada container agar klik tidak memicu pembukaan gambar
            htmlContent += `
                <div class="checkbox-container" onclick="event.stopPropagation()">
                    <input type="checkbox" class="select-checkbox" onchange="toggleSelect(event, '${fileData.key}')">
                </div>`;
        }
        
        htmlContent += `<div class="icon-box">${icon}</div><div class="name">${name}</div>`;
        div.innerHTML = htmlContent;

        if (!isFolder) {
            const act = document.createElement('div');
            act.className = 'item-actions';
            // Pastikan setiap tombol menghentikan event agar tidak memicu player induk
            act.innerHTML = `
                <button class="btn-small" onclick="event.stopPropagation(); copyLink('${fileData.url}')">Link</button>
                <button class="btn-small" onclick="event.stopPropagation(); duplicateFile('${fileData.key}')">Dup</button>
                <button class="btn-small" onclick="event.stopPropagation(); renameFile('${fileData.key}')">Name</button>
                <button class="btn-small btn-del" onclick="event.stopPropagation(); deleteFile('${fileData.key}')">üóëÔ∏è</button>
            `;
            div.appendChild(act);
        }
        div.onclick = action;
        return div;
    }

    function toggleSelect(event, key) {
        // StopPropagation sudah ditangani di parent container
        if (event.target.checked) {
            selectedFiles.add(key);
            event.target.closest('.item').classList.add('selected');
        } else {
            selectedFiles.delete(key);
            event.target.closest('.item').classList.remove('selected');
        }
        updateBulkDeleteUI();
    }

    function updateBulkDeleteUI() {
        const btn = document.getElementById('btnBulkDelete');
        const count = document.getElementById('countSelected');
        if (selectedFiles.size > 0) {
            btn.style.display = 'flex';
            count.innerText = selectedFiles.size;
        } else {
            btn.style.display = 'none';
        }
    }

    async function hapusTerpilih() {
        if (!confirm(`Hapus ${selectedFiles.size} file yang dipilih?`)) return;
        const promises = Array.from(selectedFiles).map(key => 
            fetch(`${API_URL}?action=delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
                body: JSON.stringify({ key })
            })
        );
        try {
            await Promise.all(promises);
            alert("Berhasil menghapus file terpilih.");
            muatData();
        } catch (e) { alert("Beberapa file gagal dihapus."); }
    }

    async function renameFile(oldKey) {
        const nameOnly = oldKey.split('/').pop();
        const newName = prompt("Ubah nama file menjadi:", nameOnly);
        if (!newName || newName === nameOnly) return;
        
        const path = oldKey.includes('/') ? oldKey.substring(0, oldKey.lastIndexOf("/") + 1) : "";
        const newKey = path + newName;

        try {
            await fetch(`${API_URL}?action=rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
                body: JSON.stringify({ oldKey, newKey, keepOriginal: false }) 
            });
            alert("Nama berhasil diubah!");
            muatData();
        } catch (e) { alert("Gagal mengubah nama!"); }
    }

    async function duplicateFile(oldKey) {
        const nameOnly = oldKey.split('/').pop();
        const newName = prompt("Nama file duplikat:", "copy_" + nameOnly);
        if (!newName) return;
        const path = oldKey.includes('/') ? oldKey.substring(0, oldKey.lastIndexOf("/") + 1) : "";
        const newKey = path + newName;
        try {
            await fetch(`${API_URL}?action=rename`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
                body: JSON.stringify({ oldKey, newKey, keepOriginal: true }) 
            });
            alert("Berhasil diduplikasi!");
            muatData();
        } catch (e) { alert("Gagal duplikasi!"); }
    }

    function openPlayer(startIndex) {
        const wrapper = document.getElementById('playerWrapper');
        wrapper.innerHTML = "";
        mediaFiles.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            const ext = file.key.split('.').pop().toLowerCase();
            if (['mp4','webm'].includes(ext)) slide.innerHTML = `<video src="${file.url}" controls playsinline></video>`;
            else if (['jpg','jpeg','png','gif','webp'].includes(ext)) slide.innerHTML = `<img src="${file.url}" class="player-image">`;
            else slide.innerHTML = `<div style="color:white">üìÑ ${file.key}</div>`;
            wrapper.appendChild(slide);
        });

        document.getElementById('playerOverlay').style.display = 'flex';
        if (swiperInstance) swiperInstance.destroy();
        swiperInstance = new Swiper('.swiper', {
            initialSlide: startIndex,
            simulateTouch: true,
            grabCursor: true,
            keyboard: { enabled: true }
        });
    }

    function closePlayer() {
        const currentIndex = swiperInstance.activeIndex; 
        document.getElementById('playerOverlay').style.display = 'none';
        document.querySelectorAll('video').forEach(v => v.pause());

        setTimeout(() => {
            const targetCard = document.getElementById(`card-${currentIndex}`);
            if (targetCard) {
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetCard.style.outline = "2px solid var(--blue)";
                setTimeout(() => targetCard.style.outline = "none", 1500);
            }
        }, 100);
    }

    function goPath(p) { currentPath = p; muatData(); }
    function openUploadModal() { 
        document.getElementById('targetPathDisplay').innerText = currentPath || "Root";
        document.getElementById('uploadModal').style.display = 'flex'; 
    }
    function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }

    async function prosesUpload() {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return;
        for (let file of files) {
            const formData = new FormData();
            const fullPath = currentPath ? currentPath + "/" + file.name : file.name;
            formData.append('file', file);
            formData.append('customName', fullPath);
            await fetch(`${API_URL}?action=upload`, { method: 'POST', headers: { 'X-Custom-Auth': 'admin' }, body: formData });
        }
        alert("Upload Selesai");
        closeUploadModal();
        muatData();
    }

    function copyLink(url) { navigator.clipboard.writeText(url); alert("Link disalin!"); }

    async function deleteFile(key) {
        if (!confirm("Hapus file?")) return;
        await fetch(`${API_URL}?action=delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': 'admin' },
            body: JSON.stringify({ key })
        });
        muatData();
    }

    muatData();
</script>
</body>
</html>