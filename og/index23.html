<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Video + Ken Burns + 2 Audio Track</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* CSS DARI KODE SEBELUMNYA (dipertahankan) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1300px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="url"],
        select,
        textarea,
        input[type="text"],
        input[type="range"],
        input[type="file"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4b6cb7; 
            border-radius: 50%;
            cursor: pointer;
        }


        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4b6cb7; 
            grid-column: 1 / -1;
        }

        .audio-input-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .audio-input-group > .input-group:nth-child(3) {
             grid-column: 1 / -1;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Generator Video + Ken Burns Effect + 2 Audio</h1>
        <p class="subtitle">Gambar latar akan bergerak (zoom dan pan) selama 5 detik setiap frame.</p>

        <div class="controls">
            
            <div class="section-title">ğŸ”Š Pengaturan Audio Latar (2 Track)</div>
            
            <div class="audio-input-group">
                <div class="input-group">
                    <label for="audioFileSpeech">Pilih File Suara Berbicara (Narasi):</label>
                    <input type="file" id="audioFileSpeech" accept="audio/mp3, audio/ogg, audio/wav">
                </div>
                
                <div class="input-group">
                    <label>Volume Narasi (0.0 - 1.0):</label>
                    <input type="range" id="audioVolumeSpeech" value="1.0" min="0.0" max="1.0" step="0.01">
                </div>
                <div class="input-group">
                    <audio id="audioSourceSpeech" controls loop style="width: 100%;"></audio>
                </div>
            </div>

            <div class="audio-input-group">
                <div class="input-group">
                    <label for="audioFileMusic">Pilih File Musik Latar (Backsound):</label>
                    <input type="file" id="audioFileMusic" accept="audio/mp3, audio/ogg, audio/wav">
                </div>

                <div class="input-group">
                    <label>Volume Musik (0.0 - 1.0):</label>
                    <input type="range" id="audioVolumeMusic" value="0.3" min="0.0" max="1.0" step="0.01">
                </div>
                 <div class="input-group">
                    <audio id="audioSourceMusic" controls loop style="width: 100%;"></audio>
                </div>
            </div>

            <div class="section-title">ğŸ–¼ï¸ Pengaturan Ken Burns Effect</div>
            
             <div class="input-group">
                <label>Zoom Awal (Skala Start):</label>
                <input type="number" id="scaleStart" value="1.0" min="0.5" max="2.0" step="0.05">
                <span class="help-text">1.0 = ukuran asli.</span>
            </div>
            
             <div class="input-group">
                <label>Zoom Akhir (Skala End):</label>
                <input type="number" id="scaleEnd" value="1.2" min="0.5" max="2.0" step="0.05">
                <span class="help-text">Contoh: 1.2 = zoom in 20%.</span>
            </div>


            <div class="section-title">ğŸ¨ Pengaturan Tampilan</div>
            
            <div class="input-group">
                <label>Ukuran Font (Pesan Utama):</label>
                <input type="number" id="fontSizeEn" value="48" min="20" max="150">
            </div>

            <div class="input-group">
                <label>Ukuran Font (Tanggal):</label>
                <input type="number" id="fontSizeId" value="28" min="15" max="100">
            </div>

            <div class="input-group">
                <label>Warna Teks:</label>
                <input type="color" id="textColor" value="#ffffff">
            </div>
            
            <div class="input-group">
                <label>Warna Shadow Teks:</label>
                <input type="color" id="shadowColor" value="#000000">
            </div>

            <div class="section-title">ğŸ–¼ï¸ Pengaturan Background & Branding</div>

            <div class="input-group">
                <label>Kontras Gambar Background (0.5 - 2.0):</label>
                <input type="number" id="bgContrast" value="1.0" min="0.5" max="2.0" step="0.1">
            </div>
            
            <div class="input-group">
                <label>Warna Gambar Background (Hue Rotate):</label>
                <input type="range" id="bgHue" value="0" min="0" max="360" step="1">
            </div>
            
            <div class="input-group">
                <label>URL Logo:</label>
                <input type="url" id="logoUrl" value="https://cipta.my.id/og/gambar/logo-wki.png" placeholder="https://example.com/logo.png">
            </div>

            <div class="input-group">
                <label>Teks Brand:</label>
                <input type="text" id="brandText" value="Himpunan Wanita Karo Indonesia" placeholder="Nama Brand">
            </div>

            <div class="input-group">
                <label>Ukuran Logo:</label>
                <input type="number" id="logoSize" value="60" min="30" max="150">
            </div>
            
        </div>

        <div class="canvas-container">
            <canvas id="canvas" width="1200" height="630"></canvas>
        </div>

        <div class="button-group">
            <button id="previewBtn" onclick="updatePreview(0)">ğŸ”„ Preview Hari ke-1</button>
            <button id="downloadVideoBtn" onclick="startVideoRecording()">â–¶ï¸ Start Generate & Download Video (WebM)</button> 
        </div>

        <p id="statusMessage" style="text-align: center; margin-top: 20px; font-weight: bold; color: #333;"></p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Elemen Audio
        const audioFileInputSpeech = document.getElementById('audioFileSpeech');
        const audioElSpeech = document.getElementById('audioSourceSpeech');
        const audioFileInputMusic = document.getElementById('audioFileMusic');
        const audioElMusic = document.getElementById('audioSourceMusic');
        
        const DEFAULT_WIDTH = 1200;
        const DEFAULT_HEIGHT = 630;
        const PICSUM_MAX_ID = 1000;
        const FRAME_DURATION = 5000; // 5 detik per frame
        const FPS = 30; // Frame per detik untuk rekaman
        const MAX_RETRIES = 3;

        let logoImage = new Image();
        let logoLoaded = false;
        
        let mediaRecorder;
        let videoChunks = [];
        let currentDayIndex = 0;
        let animationFrameId;
        let currentImage = null;
        let isRecording = false;

        let audioContext = null;
        let gainNodeSpeech = null;
        let gainNodeMusic = null;
        let audioStreamDestination = null;

        // --- Setup Audio File Listeners ---
        function setupAudioFileListener(inputElement, audioElement) {
            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        audioElement.src = event.target.result;
                        audioElement.load();
                        document.getElementById('statusMessage').innerText = `File audio '${file.name}' berhasil dimuat.`;
                    };
                    reader.readAsDataURL(file);
                } else {
                     audioElement.removeAttribute('src');
                     audioElement.load();
                }
            });
        }
        setupAudioFileListener(audioFileInputSpeech, audioElSpeech);
        setupAudioFileListener(audioFileInputMusic, audioElMusic);
        // --- Akhir Setup Audio File Listeners ---
        
        // --- Utils: Interpolasi Linear (LERP) ---
        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }


        // Data Kutipan (tetap sama)
        function generateDecember2025Data() {
            const restMessages = [
                "Nande, berhenti sejenak. Kekuatanmu bukan hanya dalam bekerja, tapi dalam kemampuanmu untuk pulih.",
                "Hari ini, bebaskan uis (pakaian) dari beban pikiran. Isi ulang semangat Nande-Nande Karo!",
                "Keseimbangan dimulai saat Anda memberi izin pada diri sendiri untuk istirahat. Selamat hari Minggu!",
                "Anda adalah pengerajut keharmonisan rumah. Jeda hari ini untuk memastikan benang Anda kuat kembali.",
                "Istirahat adalah investasi. Nande yang bahagia adalah keluarga yang sejahtera.",
                "Adil pada diri sendiri berarti memberi jeda. Jangan biarkan produktivitas mencuri kedamaian Anda.",
                "Penting untuk meluangkan waktu bagi diri sendiri, sebelum kembali menjadi pilar bagi keluarga dan komunitas.",
                "Rayakan ketenangan. Di hari istirahat ini, jadilah ratu di rumah batin Anda. Mejuah-juah!",
                "Biarkan energi Runggu (kumpul/musyawarah) Anda pulih. Besok, Anda akan bersinar lebih terang.",
                "Kenakan senyum terindah hari ini. Tenang dan santai, itu juga sebuah pencapaian yang mulia.",
            ];
            const dailyMessages = [
                "Sebagai Nande, kasih sayangmu adalah warisan terpenting bagi anak-anak. Jangan pernah ragu akan nilai itu.",
                "Kehangatanmu di rumah adalah fondasi kokoh untuk setiap langkah karir dan cita-cita keluarga.",
                "Nande yang kuat mendidik generasi yang tangguh. Pekerjaanmu di rumah adalah yang termulia.",
                "Dukunganmu sebagai istri adalah sayap yang mengangkat pasanganmu mencapai puncak. Anda sangat berharga.",
                "Setiap makanan yang kamu sajikan adalah perwujudan cinta. Jangan anggap remeh keahlianmu ini.",
                "Kecerdasan emosionalmu, Nande, adalah kunci untuk menyelesaikan setiap Runggu keluarga dengan damai.",
                "Anda adalah benteng kebudayaan di rumah. Lestarikan nilai-nilai Karo dengan bangga.",
                "Jangan takut meminta bantuan. Kekuatan sejati ada pada kolaborasi dalam keluarga. Bersatu kita teguh.",
                "Dengan semangat Mejuah-Juah, bawa energi positif dan ketegasan ke tempat kerja Anda.",
                "Seorang wanita Karo adalah penenun takdirnya sendiri. Tetapkan tujuan dan kejar dengan gigih.",
                "Jangan pernah meremehkan bakat negosiasi dan kepemimpinan yang Anda miliki. Itu warisan leluhur.",
                "Pendidikan dan karir Anda adalah bukti bahwa wanita Karo mampu bersaing di panggung global.",
                "Keberanian dan ketegasan adalah Raga (pakaian, diri) Anda di dunia profesional. Tunjukkan sinarmu!",
                "Setiap tantangan di kantor adalah kesempatan untuk menunjukkan ketangguhan Beru/Nande Karo!",
                "Keseimbangan karir dan keluarga bukanlah pengorbanan, melainkan manajemen waktu yang cerdas.",
                "Jadilah inspirasi bagi wanita muda Karo lainnya melalui dedikasi dan integritas Anda.",
                "Wanita Karo memegang peran ganda dengan anggun. Hargai kemampuan multitasking Anda hari ini.",
                "Ingatlah, berkarir tidak mengurangi peran Anda sebagai ibu, justru menambah dimensi kekuatan.",
                "Anda adalah penjaga tradisi dan perintis masa depan. Lakukan keduanya dengan kepala tegak.",
                "Nilai seorang wanita diukur dari hatinya yang melayani, bukan dari seberapa sibuk jadwalnya.",
                "Kekuatan leluhur mengalir dalam darahmu. Gunakan warisan itu untuk melewati kesulitan hari ini.",
                "Ciptakan lingkungan yang mendukung, baik di rumah maupun di tempat kerja. Anda pantas mendapatkannya.",
                "Setiap tetes keringatmu, Nande, adalah doa yang diwujudkan dalam tindakan. Selamat berjuang!",
                "Jangan biarkan standar orang lain mendikte kebahagiaan Anda. Bahagia versi Anda adalah yang terpenting.",
                "Wanita Karo berani berbicara dan mengambil peran. Suaramu penting dan layak didengar.",
                "Fokus pada kemajuan kecil hari ini. Setiap langkah membawa Anda pada impian besarmu.",
                "Sebagai tiang keluarga, pastikan tiangmu tetap berdiri tegak. Jaga kesehatan fisik dan mental.",
                "Percayalah pada insting Anda sebagai seorang ibu dan istri. Hati Nande jarang salah.",
                "Bekerja keraslah, tetapi jangan lupa untuk merayakan diri sendiri atas semua pencapaian.",
                "Tunjukkan pada dunia bahwa kelembutan dan kekuatan dapat hidup berdampingan dalam diri seorang wanita Karo.",
                "Hari ini, jadilah pelopor di bidang Anda. Jangan ikuti jejak, buat jejakmu sendiri.",
                "Ciptakan batasan yang sehat. Anda berhak melindungi waktu dan energi pribadi Anda.",
                "Kemandirian ekonomi adalah kekuatan. Lanjutkan perjalanan Anda menuju kemandirian penuh.",
                "Anda adalah duta budaya. Banggalah dengan marga dan asal usulmu, dan tunjukkan pesonanya.",
                "Jangan pernah merasa bersalah karena ambisi Anda. Wanita Karo dirancang untuk menjadi luar biasa.",
                "Perlakukan kegagalan sebagai batu loncatan. Jatuh itu biasa, bangkit itu luar biasa.",
                "Hari ini adalah kesempatan untuk menginspirasi satu orang. Mulailah dengan menginspirasi diri sendiri.",
                "Ambil waktu 5 menit untuk bernapas dan bersyukur. Fokus pada apa yang Anda miliki, bukan yang kurang.",
                "Wanita Karo: Tangguh di gunung, lembut di hati. Keseimbangan ini adalah kekuatan super Anda.",
                "Lanjutkan tradisi kebaikan. Warisan terbaik yang Anda berikan adalah karakter mulia.",
                "Mejuah-juah! Semoga berkat dan kesuksesan menyertai setiap usaha baik Anda hari ini.",
                "Jadilah cermin bagi generasi muda, tunjukkan definisi sejati dari keberanian dan integritas."
            ];

            const messages = [];
            const startDate = new Date('2025-12-01T12:00:00Z'); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const daysInMonth = 31;
            let dailyMessageCounter = 0;
            let restMessageCounter = 0;
            
            for (let i = 0; i < daysInMonth; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const formatter = new Intl.DateTimeFormat('id-ID', options);
                const dateString = formatter.format(currentDate);
                let selectedMessage;
                if (currentDate.getDay() === 0) {
                    selectedMessage = restMessages[restMessageCounter % restMessages.length];
                    restMessageCounter++;
                } else {
                    selectedMessage = dailyMessages[dailyMessageCounter % dailyMessages.length]; 
                    dailyMessageCounter++;
                }

                messages.push({
                    message: selectedMessage, 
                    date: dateString 
                });
            }
            
            return messages;
        }

        function generateRandomImageUrl(width, height) {
            const newId = Math.floor(Math.random() * PICSUM_MAX_ID) + 1;
            return `https://picsum.photos/id/${newId}/${width}/${height}`;
        }

        function generateRandomPicsumIds(count) {
            const ids = new Set();
            while (ids.size < count) {
                ids.add(Math.floor(Math.random() * PICSUM_MAX_ID) + 1);
            }
            return Array.from(ids);
        }

        function loadImageWithRetry(initialUrl) {
            return new Promise((resolve) => {
                let attempts = 0;
                let currentUrl = initialUrl;

                const attemptLoad = () => {
                    attempts++;
                    const image = new Image();
                    image.crossOrigin = 'Anonymous';
                    image.src = currentUrl;

                    image.onload = () => resolve(image);

                    image.onerror = () => {
                        if (attempts < MAX_RETRIES) {
                            currentUrl = generateRandomImageUrl(DEFAULT_WIDTH, DEFAULT_HEIGHT);
                            console.warn(`Gagal memuat gambar dari URL: ${image.src}. Mencoba lagi (Percobaan ${attempts}/${MAX_RETRIES}).`);
                            attemptLoad(); 
                        } else {
                            console.error(`Gagal memuat gambar setelah ${MAX_RETRIES} percobaan. Menggunakan fallback warna.`);
                            resolve(null); 
                        }
                    };
                };

                attemptLoad();
            });
        }
        
        const quotesData = generateDecember2025Data();
        const totalImages = quotesData.length; 
        
        const randomIds = generateRandomPicsumIds(totalImages);
        const imageUrls = randomIds.map(id => 
            `https://picsum.photos/id/${id}/${DEFAULT_WIDTH}/${DEFAULT_HEIGHT}`
        );


        function wrapText(context, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0] || '';

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        /**
         * Menggambar seluruh frame, termasuk background bergerak dan overlay teks.
         * @param {number} t - Progress waktu dalam frame saat ini (0.0 hingga 1.0)
         */
        function drawTextOverlay(context, bgImg, data, alpha = 1.0, t = 0) {
            const bgW = DEFAULT_WIDTH;
            const bgH = DEFAULT_HEIGHT;
            
            const mainFontSize = parseInt(document.getElementById('fontSizeEn').value) || 48;
            const dateFontSize = parseInt(document.getElementById('fontSizeId').value) || 28;
            const textColor = document.getElementById('textColor').value;
            const shadowColor = document.getElementById('shadowColor').value;
            const brandText = document.getElementById('brandText').value; 
            const logoSize = parseInt(document.getElementById('logoSize').value) || 60; 
            
            const contrastValue = parseFloat(document.getElementById('bgContrast').value) || 1.0;
            const hueValue = parseInt(document.getElementById('bgHue').value) || 0;
            
            const padding = 60; 
            const maxWidth = bgW - (padding * 2);
            
            context.clearRect(0, 0, bgW, bgH);

            // --- Logika Ken Burns Effect (Pergerakan Background) ---
            const isBgLoaded = bgImg && bgImg.complete && bgImg.naturalWidth !== 0;

            if (isBgLoaded) {
                // 1. Ambil nilai Ken Burns dari input
                const scaleStart = parseFloat(document.getElementById('scaleStart').value) || 1.0;
                const scaleEnd = parseFloat(document.getElementById('scaleEnd').value) || 1.2;
                
                // Set parameter pan (pergeseran)
                // Contoh: bergerak dari Kiri Atas (0, 0) ke Kanan Bawah
                const panXStart = 0;
                const panYStart = 0;
                const panXEnd = (scaleEnd - 1) * bgW * -0.5; // Maksimum pan di bagian kiri
                const panYEnd = (scaleEnd - 1) * bgH * -0.5; // Maksimum pan di bagian atas

                // Hitung nilai tengah (pivot point)
                const pivotX = bgW / 2;
                const pivotY = bgH / 2;

                // Hitung skala dan offset saat ini menggunakan LERP (t = 0.0 sampai 1.0)
                const currentScale = lerp(scaleStart, scaleEnd, t);
                const currentPanX = lerp(panXStart, panXEnd, t);
                const currentPanY = lerp(panYStart, panYEnd, t);


                context.save(); // Simpan kondisi kanvas saat ini
                context.filter = `contrast(${contrastValue}) hue-rotate(${hueValue}deg)`;

                // Langkah 1: Pindah ke pivot (tengah)
                context.translate(pivotX, pivotY); 
                // Langkah 2: Skala (Zoom)
                context.scale(currentScale, currentScale); 
                // Langkah 3: Geser (Pan)
                context.translate(currentPanX / currentScale, currentPanY / currentScale); // Bagi dengan scale untuk kompensasi

                // Gambar Background
                // Gambar di (-pivotX, -pivotY) agar gambar berpusat pada pivot
                context.drawImage(bgImg, -pivotX, -pivotY, bgW, bgH);
                
                context.filter = 'none'; 
                context.fillStyle = 'rgba(0, 0, 0, 0.5)'; // Overlay gelap
                context.fillRect(-pivotX, -pivotY, bgW, bgH); // Gambar overlay pada posisi yang sama

                context.restore(); // Kembalikan kondisi kanvas (transformasi hilang)

            } else {
                // Fallback (jika gambar gagal dimuat)
                const gradient = context.createLinearGradient(0, 0, bgW, bgH);
                gradient.addColorStop(0, '#4b6cb7'); 
                gradient.addColorStop(1, '#182848');
                context.fillStyle = gradient;
                context.fillRect(0, 0, bgW, bgH);
            }
            
            // --- Logika Overlay Teks dan Logo (sama seperti sebelumnya, tanpa transformasi) ---
            const brandPadding = 40; 
            const logoY = brandPadding;

            context.fillStyle = '#ffffff';
            const brandFontSize = 28;
            context.font = `bold ${brandFontSize}px Segoe UI, sans-serif`;
            const textWidth = context.measureText(brandText).width;
            
            const currentLogoSize = logoSize;
            const totalWidth = logoLoaded ? (currentLogoSize + 15 + textWidth) : textWidth;
            const logoX = bgW - brandPadding - totalWidth;
            
            context.globalAlpha = 1.0; 

            // Draw Logo
            if (logoLoaded) {
                context.shadowColor = shadowColor;
                context.shadowBlur = 5;
                context.shadowOffsetX = 2;
                context.shadowOffsetY = 2;
                context.drawImage(logoImage, logoX, logoY, currentLogoSize, currentLogoSize);
                context.shadowColor = 'transparent'; 
                context.shadowBlur = 0;
                context.shadowOffsetX = 0;
                context.shadowOffsetY = 0;
            }

            // Draw Brand Text
            context.shadowColor = shadowColor;
            context.shadowBlur = 5;
            context.shadowOffsetX = 2;
            context.shadowOffsetY = 2;

            context.textAlign = 'left';
            context.textBaseline = 'middle';
            const brandTextY = logoY + currentLogoSize / 2;
            const brandTextX = logoLoaded ? (logoX + currentLogoSize + 15) : logoX;
            context.fillText(brandText, brandTextX, brandTextY);
            
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;

            // Draw Main Text
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            
            context.globalAlpha = alpha; 
            
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            const linesMessage = wrapText(context, data.message, maxWidth);
            const lineHeightMessage = mainFontSize * 1.4;
            const totalTextHeightMessage = linesMessage.length * lineHeightMessage;

            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`; 
            const linesDate = wrapText(context, data.date, maxWidth); 
            const lineHeightDate = dateFontSize * 1.4;
            const totalTextHeightDate = linesDate.length * lineHeightDate;

            const spacing = 40; 
            const totalTextHeight = totalTextHeightMessage + spacing + totalTextHeightDate;

            let startY = (bgH - totalTextHeight) / 2;
            
            context.shadowColor = shadowColor;
            context.shadowBlur = 10;
            context.shadowOffsetX = 3;
            context.shadowOffsetY = 3;
            
            context.fillStyle = textColor;
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesMessage.forEach((line, index) => {
                const yPos = startY + (index * lineHeightMessage) + (lineHeightMessage / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            startY += totalTextHeightMessage + spacing;

            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesDate.forEach((line, index) => {
                const yPos = startY + (index * lineHeightDate) + (lineHeightDate / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            context.globalAlpha = 1.0; 
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;
        }

        async function updatePreview(index) {
            if (isRecording) return; 

            const initialUrl = imageUrls[index];
            const data = quotesData[index];
            currentDayIndex = index;
            
            document.getElementById('statusMessage').innerText = `Loading Preview Hari ke-${index + 1}/${totalImages} (Desember 2025)...`;

            const image = await loadImageWithRetry(initialUrl);
            currentImage = image; 
            
            // Tampilkan preview, Ken Burns effect diatur di t=0
            drawTextOverlay(ctx, currentImage, data, 1.0, 0); 
            document.getElementById('statusMessage').innerText = `Preview Hari ke-${index + 1}/${totalImages} ditampilkan. (Tanggal: ${data.date})`;
        }


        // =========================================================
        // === LOGIKA ANIMASI & PEREKAMAN ===
        // =========================================================

        function setupAudioStream() {
            const isSpeechLoaded = !!audioElSpeech.src;
            const isMusicLoaded = !!audioElMusic.src;
            
            if (!isSpeechLoaded && !isMusicLoaded) {
                document.getElementById('statusMessage').innerText = "âš ï¸ Harap unggah minimal satu file audio (Narasi atau Musik) terlebih dahulu!";
                return null;
            }

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (!audioStreamDestination) {
                audioStreamDestination = audioContext.createMediaStreamDestination();
            }

            let trackCount = 0;
            
            // --- 1. Setup Stream Narasi ---
            if (isSpeechLoaded) {
                const sourceSpeech = audioContext.createMediaElementSource(audioElSpeech);
                if (!gainNodeSpeech) {
                    gainNodeSpeech = audioContext.createGain();
                }
                const volumeSpeech = document.getElementById('audioVolumeSpeech');
                gainNodeSpeech.gain.value = parseFloat(volumeSpeech.value);
                volumeSpeech.oninput = () => {
                    gainNodeSpeech.gain.value = parseFloat(volumeSpeech.value);
                };
                
                sourceSpeech.connect(gainNodeSpeech);
                gainNodeSpeech.connect(audioStreamDestination);
                gainNodeSpeech.connect(audioContext.destination); 
                trackCount++;
            } else if (gainNodeSpeech) {
                gainNodeSpeech.disconnect();
            }

            // --- 2. Setup Stream Musik ---
            if (isMusicLoaded) {
                const sourceMusic = audioContext.createMediaElementSource(audioElMusic);
                if (!gainNodeMusic) {
                    gainNodeMusic = audioContext.createGain();
                }
                const volumeMusic = document.getElementById('audioVolumeMusic');
                gainNodeMusic.gain.value = parseFloat(volumeMusic.value);
                volumeMusic.oninput = () => {
                    gainNodeMusic.gain.value = parseFloat(volumeMusic.value);
                };
                
                sourceMusic.connect(gainNodeMusic);
                gainNodeMusic.connect(audioStreamDestination);
                gainNodeMusic.connect(audioContext.destination); 
                trackCount++;
            } else if (gainNodeMusic) {
                gainNodeMusic.disconnect();
            }
            
            if (trackCount === 0) {
                 document.getElementById('statusMessage').innerText = "âš ï¸ Harap unggah minimal satu file audio!";
                 return null;
            }

            const audioTrack = audioStreamDestination.stream.getAudioTracks()[0];
            
            if (!audioTrack) {
                throw new Error("Gagal mendapatkan Audio Track Gabungan.");
            }
            
            return audioTrack;
        }

        let startTime = 0;
        let lastDayRendered = -1;

        /**
         * Fungsi utama loop animasi (dipanggil 30 kali per detik)
         */
        function animateFrame(timestamp) {
            if (!startTime) startTime = timestamp;
            let elapsed = timestamp - startTime;

            // Cek apakah frame harus ganti
            if (elapsed > FRAME_DURATION) {
                currentDayIndex++; 
                if (currentDayIndex < totalImages) {
                    // Reset untuk frame baru
                    startTime = timestamp; 
                    elapsed = 0; // Mulai elapsed dari 0 untuk frame baru
                    loadNextDayContent(currentDayIndex);
                } else {
                    stopRecording();
                    return; 
                }
            }
            
            const currentData = quotesData[currentDayIndex];
            const timeInCurrentFrame = elapsed;

            // 1. Hitung Progress (t) untuk Ken Burns Effect
            let t = timeInCurrentFrame / FRAME_DURATION;
            
            // 2. Hitung Alpha (Fade In/Out)
            let alpha = 1.0;
            const transitionTime = 500; 
            
            if (timeInCurrentFrame < transitionTime) {
                alpha = timeInCurrentFrame / transitionTime;
            } else if (timeInCurrentFrame > FRAME_DURATION - transitionTime) {
                alpha = (FRAME_DURATION - timeInCurrentFrame) / transitionTime;
            }

            alpha = Math.max(0.0, Math.min(1.0, alpha)); 

            // 3. Gambar Frame (Background bergerak)
            if (currentImage) {
                 drawTextOverlay(ctx, currentImage, currentData, alpha, t); // Kirim t ke fungsi gambar
                 
                 if (currentDayIndex !== lastDayRendered) {
                    document.getElementById('statusMessage').innerText = 
                        `ğŸ¥ RECORDING... Hari ke-${currentDayIndex + 1}/${totalImages} (durasi: 5 detik).`;
                    lastDayRendered = currentDayIndex;
                }
            }

            animationFrameId = requestAnimationFrame(animateFrame);
        }

        async function loadNextDayContent(index) {
            const initialUrl = imageUrls[index];
            const image = await loadImageWithRetry(initialUrl);
            currentImage = image; 
            
            if (!isRecording) return;
        }


        /**
         * Memulai Perekaman Video + Audio
         */
        async function startVideoRecording() {
            if (!window.MediaRecorder || !canvas.captureStream) {
                alert("Browser Anda tidak mendukung MediaStream Recording API yang dibutuhkan.");
                return;
            }

            let audioTrack = setupAudioStream();
            if (!audioTrack) {
                return; 
            }

            isRecording = true;
            document.getElementById('downloadVideoBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;

            const videoStream = canvas.captureStream(FPS); 
            const combinedStream = new MediaStream();
            combinedStream.addTrack(videoStream.getVideoTracks()[0]);
            combinedStream.addTrack(audioTrack); 

            videoChunks = [];
            
            const options = { mimeType: 'video/webm; codecs=vp9,opus' }; 

            try {
                mediaRecorder = new MediaRecorder(combinedStream, options);
            } catch (e) {
                 mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });
            }

            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    videoChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                if (audioElSpeech.src) audioElSpeech.pause();
                if (audioElMusic.src) audioElMusic.pause();
                downloadVideo();
            };

            if (audioElSpeech.src) {
                audioElSpeech.currentTime = 0;
                audioElSpeech.play().catch(e => console.warn("Autoplay Narasi diblokir:", e));
            }
            if (audioElMusic.src) {
                audioElMusic.currentTime = 0;
                audioElMusic.play().catch(e => console.warn("Autoplay Musik diblokir:", e));
            }
            
            currentDayIndex = 0;
            startTime = 0;
            lastDayRendered = -1;
            await loadNextDayContent(currentDayIndex); 

            mediaRecorder.start();
            animationFrameId = requestAnimationFrame(animateFrame);
            
            document.getElementById('statusMessage').innerText = `ğŸ¥ Perekaman Dimulai! Memproses Hari ke-1... (Total 31 hari, durasi: ${totalImages * 5} detik).`;
        }

        /**
         * Menghentikan Perekaman Video
         */
        function stopRecording() {
            cancelAnimationFrame(animationFrameId);
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
        }
        
        /**
         * Menggabungkan chunk dan memulai Download
         */
        function downloadVideo() {
            document.getElementById('statusMessage').innerText = "âœ… Selesai merekam! Menggabungkan video, harap tunggu...";
            
            const blob = new Blob(videoChunks, { type: 'video/webm' }); 
            const videoFileName = `31_Penyemangat_Wanita_Karo_MIXED_AUDIO_KEN_BURNS.webm`;
            
            saveAs(blob, videoFileName);
            
            document.getElementById('downloadVideoBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('statusMessage').innerText = `ğŸ‰ Video ${videoFileName} berhasil diunduh.`;
        }


        // Initial render (Hari ke-1)
        updatePreview(0);
    </script>
</body>
</html>