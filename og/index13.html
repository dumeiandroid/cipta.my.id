<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Otomatis Harian - Lidan Psikologi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Gaya CSS tidak diubah dari versi sebelumnya */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1300px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="url"],
        select,
        textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="number"]:focus,
        input[type="url"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            grid-column: 1 / -1;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }


        .canvas-container {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: auto;
        }

        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 100%;
            height: auto;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            grid-column: 1 / -1;
        }

        .help-text {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ú® Generator Otomatis Kutipan Harian - Lidan Psikologi (365 Hari)</h1>
        <p class="subtitle">Membuat 365 gambar kutipan inspiratif harian, dimulai dari 1 Januari 2026. Dimensi 1200x630.</p>

        <div class="controls">
            <div class="section-title">üé® Pengaturan Tampilan Teks</div>
            
            <div class="input-group">
                <label>Ukuran Font Kutipan:</label>
                <input type="number" id="fontSizeMain" value="48" min="20" max="150">
            </div>

            <div class="input-group">
                <label>Warna Teks:</label>
                <input type="color" id="textColor" value="#ffffff">
            </div>
            
            <div class="input-group">
                <label>Warna Shadow Teks:</label>
                <input type="color" id="shadowColor" value="#000000">
                <span class="help-text">Tambahkan shadow untuk visibilitas.</span>
            </div>

            <div class="input-group">
                <label>Ukuran Font Tanggal:</label>
                <input type="number" id="fontSizeDate" value="24" min="16" max="60">
            </div>

            <div class="section-title">üñºÔ∏è Pengaturan Background</div>
            
            <div class="input-group">
                <label>Kontras Gambar Background (0.5 - 2.0):</label>
                <input type="number" id="bgContrast" value="1.0" min="0.5" max="2.0" step="0.1">
                <span class="help-text">1.0 = normal. Mengatur tingkat kontras.</span>
            </div>
            
            <div class="input-group">
                <label>Warna Gambar Background (Hue Rotate):</label>
                <input type="range" id="bgHue" value="0" min="0" max="360" step="1">
                <span class="help-text">0 = normal. Memutar rona warna (dalam derajat).</span>
            </div>

            <div class="section-title">üè∑Ô∏è Pengaturan Logo & Branding</div>

            <div class="input-group" style="grid-column: 1 / -1;">
                <label>URL Logo:</label>
                <input type="url" id="logoUrl" value="gambar/logo-psikologi.png" placeholder="https://example.com/logo.png">
                <span class="help-text">Masukkan URL logo (akan muncul di Kanan Atas).</span>
            </div>

            <div class="input-group">
                <label>Teks Brand:</label>
                <input type="text" id="brandText" value="Lidan Psikologi" placeholder="Nama Brand">
            </div>

            <div class="input-group">
                <label>Ukuran Logo (px):</label>
                <input type="number" id="logoSize" value="60" min="30" max="150">
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvas" width="1200" height="630"></canvas>
        </div>

        <div class="button-group">
            <button onclick="updatePreview(0)">üîÑ Update Preview (Hari ke-1 / 1 Jan 2026)</button>
            <button id="downloadButton" onclick="downloadAllImages()">‚¨áÔ∏è Mulai Download Batch 1 (Hari 1 - 100)</button> 
        </div>

        <p id="statusMessage" style="text-align: center; margin-top: 20px; font-weight: bold; color: #333;"></p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const downloadButton = document.getElementById('downloadButton');
        const statusMessage = document.getElementById('statusMessage');
        const DEFAULT_WIDTH = 1200;
        const DEFAULT_HEIGHT = 630;
        
        canvas.width = DEFAULT_WIDTH;
        canvas.height = DEFAULT_HEIGHT;

        // --- Global State untuk Batch ---
        let currentBatchIndex = 0;
        const BATCH_SIZE = 100;
        
        // --- Logo Setup ---
        let logoImage = new Image();
        let logoLoaded = false;
        
        // ... (Kode Logo Setup tetap sama)
        logoImage.src = document.getElementById('logoUrl').value;
        logoImage.onload = function() {
            logoLoaded = true;
            updatePreview(0); // Update setelah logo dimuat
        };
        logoImage.onerror = function() {
            logoLoaded = false;
            console.error('Logo gagal dimuat');
            updatePreview(0); 
        };
        
        document.getElementById('logoUrl').addEventListener('change', function() {
            const url = this.value.trim();
            if (url) {
                logoLoaded = false;
                logoImage.crossOrigin = 'Anonymous'; // Penting jika logo dari domain lain
                logoImage.src = url;
            } else {
                logoLoaded = false;
                updatePreview(0);
            }
        });

        // Data untuk 365 Kutipan (Kutipan Motivasi Bahasa Indonesia)
        const uniqueQuotes = [
            {text: "Kesempatan terbaik hari ini adalah mengambil satu langkah maju, sekecil apapun itu."},
            {text: "Percayalah pada potensi yang tersembunyi dalam dirimu. Kekuatan itu ada di sana, menunggu untuk ditemukan."},
            {text: "Kesehatan mental adalah prioritas. Beristirahatlah, bukan menyerah, dan temukan dukungan di Lidan Psikologi."},
            {text: "Bukan seberapa cepat, tapi seberapa konsisten. Konsistensi kecil membawa hasil besar dalam hidupmu."},
            {text: "Setiap tantangan adalah peluang untuk membuktikan ketangguhan dirimu. Hadapi dengan senyum dan keyakinan."},
            {text: "Kunci kebahagiaan sejati adalah menghargai proses, bukan hanya menunggu hasilnya tiba."},
            {text: "Tentukan tujuanmu. Fokus. Abaikan keraguan. Engkau lebih kuat dari yang kau duga."},
            {text: "Jangan biarkan masa lalu merampas energi untuk menciptakan masa depan yang indah dan baru."},
            {text: "Masa depan yang cerah dimulai dengan kebiasaan positif hari ini. Mulai sekarang, jangan tunda lagi."},
            {text: "Minat adalah kompas, bakat adalah peta. Gabungkan keduanya untuk menemukan jalan suksesmu yang unik."},
            {text: "Temukan apa yang membuatmu bersemangat, dan jadikan itu bahan bakar untuk setiap langkahmu."},
            {text: "Kegagalan hanyalah umpan balik. Pelajari, bangkit, dan coba lagi dengan cara yang lebih baik."},
            {text: "Jadilah dirimu sendiri. Dunia membutuhkan keunikan dan cahaya yang hanya kamu miliki."},
            {text: "Cintai pekerjaanmu. Saat kamu mencintai, bekerja terasa seperti bermain."},
            {text: "Ubah pikiran negatif menjadi pertanyaan yang membangun: 'Apa yang bisa saya lakukan sekarang?'"},
            {text: "Kebaikan kecil yang kamu tabur hari ini akan mekar menjadi kebahagiaan yang besar di masa depan."},
            {text: "Fokus pada apa yang bisa kamu kendalikan. Lepaskan apa yang tidak. Itulah kedamaian pikiran."},
            {text: "Jangan pernah berhenti belajar. Pikiran yang terbuka adalah pintu menuju kemungkinan tak terbatas."},
            {text: "Tuliskan tujuanmu. Lihat setiap hari. Kekuatan visualisasi sangat besar."},
            {text: "Kualitas hidupmu ditentukan oleh kualitas pertanyaan yang kamu ajukan pada dirimu sendiri."},
            {text: "Keputusan terbaik adalah memulai. Sisanya akan mengikuti seiring kamu bergerak."},
            {text: "Sukses adalah serangkaian kegagalan kecil yang diatasi dengan kegigihan besar."},
            {text: "Ingat, kamu tidak sendirian dalam perjuangan ini. Konseling adalah tanda kekuatan, bukan kelemahan."},
            {text: "Bakat terpendammu adalah harta karun. Tes Minat dan Bakat membantu membukanya."},
            {text: "Langkah kecil setiap hari lebih baik daripada rencana besar yang tidak pernah dimulai."},
            {text: "Dirimu di masa depan berterima kasih atas kerja kerasmu hari ini."},
            {text: "Jangan bandingkan prosesmu dengan orang lain. Fokus pada kemajuan diri sendiri."},
            {text: "Perubahan dimulai dari dalam. Kembangkan pola pikir yang positif dan tangguh."},
            {text: "Rasa cemas hari ini akan menjadi kekuatan besok, jika kamu mau mengolahnya."},
            {text: "Tujuan tanpa rencana hanyalah harapan. Buat rencana, dan raih apa yang kamu inginkan."},
            {text: "Jangan takut akan lambat, takutlah jika kamu berhenti di tengah jalan."},
            {text: "Hari ini adalah kesempatan baru untuk menulis kisah yang lebih baik dari kemarin."},
            {text: "Berikan yang terbaik, dan hasilnya akan mengikuti kualitas usahamu."},
            {text: "Jadikan kesulitan sebagai guru terbaikmu. Mereka membentuk dirimu yang tangguh."},
            {text: "Kembangkan kebiasaan baik; mereka adalah arsitek dari keberhasilanmu."},
        ];

        // Buat array quotesData dengan 365 entri dari uniqueQuotes (diulang)
        const totalImages = 365;
        const quotesData = Array.from({length: totalImages}, (_, i) => uniqueQuotes[i % uniqueQuotes.length]);

        // URL Gambar Picsum (Gunakan 365 ID berbeda)
        const imageUrls = Array.from({length: totalImages}, (_, i) => 
            `https://picsum.photos/id/${100 + i}/${DEFAULT_WIDTH}/${DEFAULT_HEIGHT}`
        );


        // --- Event listeners untuk kontrol lainnya ---
        document.getElementById('fontSizeMain').addEventListener('input', () => updatePreview(0));
        document.getElementById('fontSizeDate').addEventListener('input', () => updatePreview(0));
        document.getElementById('textColor').addEventListener('input', () => updatePreview(0));
        document.getElementById('shadowColor').addEventListener('input', () => updatePreview(0));
        document.getElementById('bgContrast').addEventListener('input', () => updatePreview(0));
        document.getElementById('bgHue').addEventListener('input', () => updatePreview(0));
        document.getElementById('brandText').addEventListener('input', () => updatePreview(0));
        document.getElementById('logoSize').addEventListener('input', () => updatePreview(0));


        /**
         * Fungsi untuk memecah teks menjadi baris
         */
        function wrapText(context, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0] || '';

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        /**
         * Menghitung tanggal, bulan, tahun, dan hari untuk indeks tertentu
         * Dimulai dari 1 Januari 2026.
         */
        function calculateDate(index) {
            // Set start date to 2026-01-01 (using UTC to prevent local timezone offset issues)
            const startDate = new Date('2026-01-01T00:00:00Z'); 
            const targetDate = new Date(startDate);
            targetDate.setUTCDate(startDate.getUTCDate() + index);

            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            return {
                day: days[targetDate.getUTCDay()],
                date: targetDate.getUTCDate(),
                month: months[targetDate.getUTCMonth()],
                year: targetDate.getUTCFullYear()
            };
        }

        /**
         * Fungsi untuk menggambar overlay teks pada objek canvas/konteks tertentu
         */
        function drawTextOverlay(context, bgImg, quote, index) {
            const bgW = DEFAULT_WIDTH;
            const bgH = DEFAULT_HEIGHT;
            
            const fontSizeMain = parseInt(document.getElementById('fontSizeMain').value) || 48;
            const fontSizeDate = parseInt(document.getElementById('fontSizeDate').value) || 24;
            const textColor = document.getElementById('textColor').value;
            const shadowColor = document.getElementById('shadowColor').value;
            const brandText = document.getElementById('brandText').value;
            const logoSize = parseInt(document.getElementById('logoSize').value) || 60;
            
            // Ambil nilai filter
            const contrastValue = parseFloat(document.getElementById('bgContrast').value) || 1.0;
            const hueValue = parseInt(document.getElementById('bgHue').value) || 0;
            
            const padding = 60; // Padding kiri/kanan
            const maxWidth = bgW - (padding * 2);
            const text = quote.text;
            
            // Clear canvas
            context.clearRect(0, 0, bgW, bgH);

            // --- Draw Background & Filters ---
            const isBgLoaded = bgImg && bgImg.complete && bgImg.naturalWidth !== 0;

            if (isBgLoaded) {
                context.filter = `contrast(${contrastValue}) hue-rotate(${hueValue}deg)`;
                
                context.drawImage(bgImg, 0, 0, bgW, bgH);
                context.fillStyle = 'rgba(0, 0, 0, 0.5)'; // Overlay hitam 50%
                context.fillRect(0, 0, bgW, bgH); 

                // Hapus filter sebelum menggambar teks
                context.filter = 'none'; 
            } else {
                // Fallback to gradient if no image
                const gradient = context.createLinearGradient(0, 0, bgW, bgH);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                context.fillStyle = gradient;
                context.fillRect(0, 0, bgW, bgH);
            }


            // --- 1. Draw Logo and Brand Text (Top Right) ---
            const logoPadding = 40;
            const logoY = logoPadding;

            context.fillStyle = '#ffffff';
            const brandFontSize = 28;
            context.font = `bold ${brandFontSize}px Segoe UI, sans-serif`;
            const textWidth = context.measureText(brandText).width;
            
            const currentLogoSize = logoSize; 
            
            // Hitung lebar total untuk teks dan logo agar rata kanan
            const totalWidth = logoLoaded && document.getElementById('logoUrl').value ? currentLogoSize + 15 + textWidth : textWidth; 
            const startX = bgW - logoPadding - totalWidth; 
            const textStartX = logoLoaded && document.getElementById('logoUrl').value ? startX + currentLogoSize + 15 : startX;

            // Draw Brand Text (to the right, starting after logo if present)
            context.textAlign = 'left';
            context.textBaseline = 'middle';
            const brandTextY = logoY + currentLogoSize / 2;
            context.fillText(brandText, textStartX, brandTextY);

            // Draw logo if loaded (on the LEFT of brand text)
            if (logoLoaded && document.getElementById('logoUrl').value) {
                context.drawImage(logoImage, startX, logoY, currentLogoSize, currentLogoSize);
            }

            // --- 2. Draw Main Text (Center) ---
            
            // Terapkan shadow untuk visibilitas
            context.shadowColor = shadowColor;
            context.shadowBlur = 10;
            context.shadowOffsetX = 3;
            context.shadowOffsetY = 3;

            context.fillStyle = textColor;
            context.font = `bold ${fontSizeMain}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            
            const lines = wrapText(context, text, maxWidth);
            const lineHeight = fontSizeMain * 1.4;
            const totalTextHeight = lines.length * lineHeight;
            
            // Posisi di tengah vertikal, sedikit ke atas untuk memberi ruang pada tanggal
            let startY = (bgH / 2) - (totalTextHeight / 2) + 20; 
            
            lines.forEach((line, i) => {
                const yPos = startY + (i * lineHeight) + (lineHeight / 2);
                context.fillText(line, bgW / 2, yPos);
            });

            // Nonaktifkan shadow
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;
            
            // --- 3. Draw Date/Day (Bottom Right) ---
            const dateObj = calculateDate(index);
            const dateText = `${dateObj.day}, ${dateObj.date} ${dateObj.month} ${dateObj.year}`;
            
            context.fillStyle = '#ffffff'; // Warna putih untuk tanggal
            context.font = `${fontSizeDate}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            context.textAlign = 'right';
            context.textBaseline = 'bottom';
            
            const dateX = bgW - padding;
            const dateY = bgH - padding;
            
            context.fillText(dateText, dateX, dateY);
        }


        function updatePreview(index) {
            const imageUrl = imageUrls[index];
            const quote = quotesData[index];
            const image = new Image();
            
            const dateObj = calculateDate(index);
            const previewText = `${dateObj.day}, ${dateObj.date} ${dateObj.month} ${dateObj.year}`;

            statusMessage.innerText = `Loading Preview Hari ke-${index + 1} (${previewText})...`;

            image.crossOrigin = 'Anonymous'; 
            image.src = imageUrl;

            image.onload = function() {
                drawTextOverlay(ctx, image, quote, index);
                statusMessage.innerText = `Preview Hari ke-${index + 1} (${previewText}) ditampilkan.`;
            };

            image.onerror = function() {
                console.error(`Gagal memuat gambar untuk preview: ${imageUrl}`);
                statusMessage.innerText = `Gagal memuat gambar ${index + 1}. Menampilkan background fallback.`;
                drawTextOverlay(ctx, null, quote, index); 
            };
        }

        /**
         * Helper function untuk memuat satu gambar dengan Promise dan TIMEOUT.
         */
        function loadSingleImage(url, index, batchNumber, totalBatches) {
            const TIMEOUT_MS = 8000; // Batas waktu 8 detik
            
            const dateObj = calculateDate(index);
            const progressDateText = `${dateObj.day}, ${dateObj.date} ${dateObj.month} ${dateObj.year}`;
            statusMessage.innerText = 
                `Memproses... (MEMUAT Gambar ke-${index + 1}/${totalImages} - Batch ${batchNumber}/${totalBatches}: ${progressDateText})... (Max ${TIMEOUT_MS / 1000}s)`;


            return new Promise(resolve => {
                let timeoutId = null;

                const image = new Image();
                image.crossOrigin = 'Anonymous';

                // 1. Atur Timeout
                timeoutId = setTimeout(() => {
                    // Menonaktifkan event handler jika timeout terjadi
                    image.onload = null; 
                    image.onerror = null;
                    console.warn(`Timeout! Gambar ${index + 1} (${progressDateText}) gagal dimuat dalam ${TIMEOUT_MS / 1000} detik. Menggunakan fallback.`);
                    resolve({image: null, isFallback: true});
                }, TIMEOUT_MS);
                
                // 2. Event Berhasil Dimuat
                image.onload = function() {
                    clearTimeout(timeoutId); // Hapus timeout jika berhasil
                    resolve({image: image, isFallback: false}); 
                };

                // 3. Event Gagal Dimuat
                image.onerror = function() {
                    clearTimeout(timeoutId); // Hapus timeout jika terjadi error
                    console.error(`Gagal memuat gambar ${index + 1} dari URL: ${url}. Menggunakan fallback.`);
                    resolve({image: null, isFallback: true});
                };
                
                // Mulai memuat gambar
                image.src = url;
            });
        }


        /**
         * Memproses satu gambar, menggambarnya di kanvas, dan menambahkannya ke ZIP.
         */
        function processSingleImage(zip, index, batchNumber, totalBatches) {
            return new Promise(async resolve => {
                const imageUrl = imageUrls[index];
                const quote = quotesData[index];
                const KUALITAS_KOMPRESI = 0.8; 

                // Tunggu hingga gambar selesai dimuat (atau gagal/timeout)
                const {image, isFallback} = await loadSingleImage(imageUrl, index, batchNumber, totalBatches);

                // Buat kanvas baru di memori
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = DEFAULT_WIDTH;
                tempCanvas.height = DEFAULT_HEIGHT;
                const tempCtx = tempCanvas.getContext('2d');

                // Gambar overlay teks
                drawTextOverlay(tempCtx, image, quote, index);
                
                // Tentukan nama file menggunakan tanggal
                const dateObj = calculateDate(index);
                const dateFileName = `${dateObj.year}-${(dateObj.month).slice(0, 3).toUpperCase()}-${dateObj.date.toString().padStart(2, '0')}`;
                const fallbackSuffix = isFallback ? '_FALLBACK' : '';
                const fileName = `Lidan_Psikologi_${dateFileName}${fallbackSuffix}.jpeg`; 

                // Konversi Canvas ke Data URL JPEG
                const dataUrl = tempCanvas.toDataURL('image/jpeg', KUALITAS_KOMPRESI);
                
                // Tambahkan file ke objek ZIP
                const base64Data = dataUrl.split(',')[1];
                zip.file(fileName, base64Data, {base64: true});

                // Update progress setelah selesai diproses
                const progressDateText = `${dateObj.day}, ${dateObj.date} ${dateObj.month} ${dateObj.year}`;
                const statusSuffix = isFallback ? ' (Menggunakan FALLBACK)' : '';
                statusMessage.innerText = 
                    `Memproses... (Gambar ke-${index + 1}/${totalImages} - Batch ${batchNumber}/${totalBatches}: ${progressDateText}) SELESAI.${statusSuffix} Lanjut ke gambar berikutnya.`;

                resolve(); // Lanjutkan ke Promise/gambar berikutnya
            });
        }
        
        /**
         * FUNGSI UTAMA DOWNLOAD YANG MENGONTROL ALIRAN BATCH
         */
        function getBatchInfo(batchIndex) {
            const totalBatches = Math.ceil(totalImages / BATCH_SIZE);
            const startIndex = batchIndex * BATCH_SIZE;
            
            let endIndex = startIndex + BATCH_SIZE;
            if (endIndex > totalImages) {
                endIndex = totalImages;
            }
            return { startIndex, endIndex, batchNumber: batchIndex + 1, totalBatches };
        }

        async function downloadAllImages() {
            const totalBatches = Math.ceil(totalImages / BATCH_SIZE);

            if (currentBatchIndex >= totalBatches) {
                statusMessage.innerHTML = `‚úÖ **Semua ${totalImages} gambar sudah selesai diunduh.**`;
                downloadButton.disabled = true;
                return;
            }

            // --- Persiapan Batch ---
            downloadButton.disabled = true;
            downloadButton.innerText = 'Sedang Memproses Batch...';

            const { startIndex, endIndex, batchNumber } = getBatchInfo(currentBatchIndex);
            const numFilesInBatch = endIndex - startIndex;
            const zip = new JSZip();
            
            statusMessage.innerText = 
                `Mulai memproses Batch ${batchNumber}/${totalBatches} (${startIndex + 1} - ${endIndex} dari ${totalImages})...`;

            try {
                // --- Proses Gambar Berurutan dalam Batch ---
                for (let i = startIndex; i < endIndex; i++) {
                    await processSingleImage(zip, i, batchNumber, totalBatches); 
                }

                // --- Kompresi dan Download ZIP Batch ---
                statusMessage.innerText = 
                    `Batch ${batchNumber} selesai diproses. Mengompres ${numFilesInBatch} file ZIP...`;

                const content = await zip.generateAsync({type:"blob"});
                const zipFileName = `Lidan_Psikologi_Batch_${batchNumber}_(${startIndex + 1}sd${endIndex}).zip`;
                saveAs(content, zipFileName);

                currentBatchIndex++;
                
                // --- Update Status dan Tombol untuk Batch Selanjutnya ---
                if (currentBatchIndex < totalBatches) {
                    const nextBatchInfo = getBatchInfo(currentBatchIndex);
                    downloadButton.disabled = false;
                    downloadButton.innerHTML = `‚¨áÔ∏è Lanjut Download Batch ${currentBatchIndex + 1} (Hari ${nextBatchInfo.startIndex + 1} - ${nextBatchInfo.endIndex})`;
                    statusMessage.innerHTML = 
                        `‚úÖ Batch **${batchNumber}** berhasil diunduh. Klik tombol di atas untuk melanjutkan ke **Batch ${currentBatchIndex + 1}** (Total ${totalBatches} Batch).`;
                } else {
                    // Semua Batch Selesai
                    downloadButton.disabled = true;
                    downloadButton.innerHTML = `‚úÖ Selesai (Total ${totalImages} Gambar)`;
                    statusMessage.innerHTML = 
                        `üéâ **Selesai!** Semua ${totalImages} gambar telah berhasil diunduh dalam ${totalBatches} Batch.`;
                }

            } catch (error) {
                // --- Penanganan Error ---
                downloadButton.disabled = false;
                downloadButton.innerText = 'Coba Lagi Download Batch Ini';
                statusMessage.innerHTML = `‚ùå Terjadi kesalahan fatal selama proses Batch **${batchNumber}**: ${error.message}. Coba klik tombol di atas lagi.`;
                console.error("Kesalahan proses ZIP:", error);
            }
        }

        // Initial render
        updatePreview(0); // Tampilkan kutipan pertama sebagai preview
    </script>
</body>
</html>