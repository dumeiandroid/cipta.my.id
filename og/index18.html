<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator 1 Tahun Penuh - Himpunan Wanita Karo Indonesia (2026)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Nuansa warna yang kuat/berani, misalnya ungu/biru tua */
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1300px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="url"],
        select,
        input[type="text"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="number"]:focus,
        input[type="url"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #4b6cb7;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4b6cb7;
            border-radius: 50%;
            cursor: pointer;
        }


        .canvas-container {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: auto;
        }

        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 100%;
            height: auto;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); 
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(75, 108, 183, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4b6cb7;
            grid-column: 1 / -1;
        }

        .help-text {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóìÔ∏è Generator **365 Hari** Penyemangat: Wanita Karo Tangguh</h1>
        <p class="subtitle">Membuat **365 gambar** pemberdayaan HWKI untuk **1 Januari - 31 Desember 2026** dengan konten berbeda. Background acak & mekanisme retry otomatis aktif.</p>

        <div class="controls">
            <div class="section-title">üé® Pengaturan Tampilan</div>
            
            <div class="input-group">
                <label>Ukuran Font (Pesan Utama):</label>
                <input type="number" id="fontSizeEn" value="48" min="20" max="150">
            </div>

            <div class="input-group">
                <label>Ukuran Font (Tanggal):</label>
                <input type="number" id="fontSizeId" value="28" min="15" max="100">
                <span class="help-text">Mengatur ukuran font untuk hari, tanggal, bulan, dan tahun.</span>
            </div>

            <div class="input-group">
                <label>Warna Teks:</label>
                <input type="color" id="textColor" value="#ffffff">
            </div>
            
            <div class="input-group">
                <label>Warna Shadow Teks:</label>
                <input type="color" id="shadowColor" value="#000000">
                <span class="help-text">Tambahkan shadow untuk visibilitas.</span>
            </div>

            <div class="section-title">üñºÔ∏è Pengaturan Background</div>

            <div class="input-group">
                <label>Kontras Gambar Background (0.5 - 2.0):</label>
                <input type="number" id="bgContrast" value="1.0" min="0.5" max="2.0" step="0.1">
                <span class="help-text">1.0 = normal. Mengatur tingkat kontras.</span>
            </div>
            
            <div class="input-group">
                <label>Warna Gambar Background (Hue Rotate):</label>
                <input type="range" id="bgHue" value="0" min="0" max="360" step="1">
                <span class="help-text">0 = normal. Memutar rona warna (dalam derajat).</span>
            </div>
            
            <div class="section-title">üè∑Ô∏è Pengaturan Logo & Branding</div>
            
            <div class="input-group">
                <label>URL Logo:</label>
                <input type="url" id="logoUrl" value="https://cipta.my.id/og/gambar/logo-wki.png" placeholder="https://example.com/logo.png">
                <span class="help-text">URL Logo HWKI.</span>
            </div>

            <div class="input-group">
                <label>Teks Brand:</label>
                <input type="text" id="brandText" value="Himpunan Wanita Karo Indonesia" placeholder="Nama Brand">
            </div>

            <div class="input-group">
                <label>Ukuran Logo:</label>
                <input type="number" id="logoSize" value="60" min="30" max="150">
                <span class="help-text">Ukuran logo dalam piksel.</span>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvas" width="1200" height="630"></canvas>
        </div>

        <div class="button-group">
            <button onclick="updatePreview(0)">üîÑ Update Preview (Hari ke-1 / 1 Jan 2026)</button>
            <button onclick="downloadAllImages()">‚¨áÔ∏è Generate & Download **365 Gambar ZIP** (Tahun 2026)</button> 
        </div>

        <p id="statusMessage" style="text-align: center; margin-top: 20px; font-weight: bold; color: #333;"></p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const DEFAULT_WIDTH = 1200;
        const DEFAULT_HEIGHT = 630;
        const MAX_RETRIES = 3; 
        const PICSUM_MAX_ID = 1000; 
        const DAYS_IN_YEAR = 365; 

        canvas.width = DEFAULT_WIDTH;
        canvas.height = DEFAULT_HEIGHT;

        let logoImage = new Image();
        let logoLoaded = false;
        
        // --- Setup Awal Logo ---
        const logoUrlInput = document.getElementById('logoUrl');
        logoImage.crossOrigin = 'Anonymous'; 
        logoImage.src = logoUrlInput.value;
        logoImage.onload = function() {
            logoLoaded = true;
            updatePreview(0); 
        };
        logoImage.onerror = function() {
            logoLoaded = false;
            updatePreview(0);
        };
        logoUrlInput.addEventListener('change', function() {
            const url = this.value.trim();
            if (url) {
                logoLoaded = false;
                logoImage.src = url;
            } else {
                logoLoaded = false;
                updatePreview(0);
            }
        });
        // --- Akhir Setup Awal Logo ---

        /**
         * FUNGSI UNTUK MENGHASILKAN DATA 365 HARI DIMULAI 1 JANUARI 2026
         */
        function generateYear2026Data() {
            // Pool Pesan Khusus Istirahat (BARU - Dihilangkan penanda ** untuk kebersihan)
            const restMessages = [
                "Hari ini, lepaskan beban kerja. Nande yang beristirahat adalah Nande yang tak terkalahkan.",
                "Jadikan hari Minggu ini Mbaru (baru) dengan memprioritaskan sukacita dan ketenangan batin.",
                "Ingatlah pepatah: Simulihken raga, mperjore raga (Memperbaiki diri, menyegarkan diri). Ambil jeda, Nande.",
                "Kekuatan seorang ibu Karo terletak pada kemampuannya untuk mencintai, termasuk mencintai dan merawat dirinya sendiri.",
                "Tubuhmu adalah rumah kedua bagi semangat juangmu. Beri nutrisi dengan istirahat yang cukup hari ini.",
                "Mejuah-juah! Di hari istirahat ini, biarkan cahaya Raga-Raga (kehormatan diri) bersinar tanpa perlu bekerja keras.",
                "Sediakan waktu untuk Runggu (musyawarah) dengan hati Anda. Dengarkan apa yang ia butuhkan.",
                "Kembali ke alam. Cari ketenangan seperti air yang mengalir di Lau Kawar.",
                "Seorang Nande yang damai akan menularkan kedamaian. Mulai dari diri sendiri hari ini.",
                "Biarkan senyum menjadi bulang (mahkota) Anda hari ini. Nikmati kebebasan tanpa jadwal.",
            ];

            // Pool Pesan Harian Baru (BARU - Dihilangkan penanda ** untuk kebersihan)
            const dailyMessages = [
                "Keberanian sejati adalah tampil apa adanya, sambil tetap menjunjung tinggi adat dan budaya Karo.",
                "Keterbatasan bukanlah halangan, melainkan undangan untuk menjadi lebih kreatif dan inovatif.",
                "Jadilah jembatan yang menghubungkan generasi muda Karo dengan akar tradisi mereka.",
                "Dalam karir, jangan takut mengambil risiko terukur. Wanita Karo dirancang untuk menjadi pemimpin.",
                "Setiap tantangan adalah ujian untuk mengasah runggun (kebijaksanaan) yang Anda miliki.",
                "Kemandirian finansial adalah bentuk cinta diri yang kuat. Teruslah berjuang untuk kemerdekaan ekonomi Anda.",
                "Sebagai istri, hargai dan dukung visi suamimu, namun jangan pernah kehilangan visi pribadimu.",
                "Rumah bukanlah tempat persembunyian, tapi pusat kekuatan tempat Anda mengisi ulang energi.",
                "Warisan terbaik yang bisa Anda berikan pada anak adalah pendidikan dan contoh ketangguhan.",
                "Nande, jangan pernah membandingkan perjalananmu dengan orang lain. Keunikanmu adalah kekuatanmu.",
                "Bawa semangat Aron (gotong royong) ke tempat kerja Anda; kolaborasi selalu lebih kuat daripada individualitas.",
                "Belajar adalah investasi seumur hidup. Teruslah tingkatkan keterampilan dan pengetahuan Anda.",
                "Pergunakan setiap kesempatan untuk berjejaring dan memperluas pengaruh HWKI di masyarakat luas.",
                "Ingat, Runggu (musyawarah) yang baik dimulai dengan mendengarkan daripada berbicara. Terapkan ini hari ini.",
                "Tunjukkan pada dunia bahwa kecantikan wanita Karo sejati ada pada integritas dan kebaikan hatinya.",
                "Jangan biarkan kata orang lain menentukan harga diri Anda. Anda yang menetapkan nilaimu.",
                "Rayakan prestasi kecil hari ini. Setiap kemenangan adalah hasil dari usaha yang konsisten.",
                "Berdirilah tegak. Anda mewarisi darah pejuang dari leluhur Karo.",
                "Ciptakan inovasi dalam peran tradisionalmu. Budaya harus tumbuh, bukan hanya dijaga.",
                "Jadilah mentor bagi wanita muda. Investasikan waktu Anda dalam memberdayakan masa depan.",
                "Setiap hari adalah halaman baru untuk menulis kisah sukses Anda sendiri. Mulai sekarang.",
                "Kesehatan mental sama pentingnya dengan kesehatan fisik. Jaga keseimbangan jiwamu.",
                "Berkomitmenlah untuk konsisten dalam tindakan positifmu, sekecil apa pun itu.",
                "Hargai perbedaan pendapat; di situlah letak kekayaan pemikiran dan kebijaksanaan.",
                "Gunakan medan sosial untuk menyebarkan pesan positif dan nilai-nilai HWKI.",
                "Kepercayaan diri Anda adalah uis (pakaian) terbaik yang Anda kenakan. Kenakan dengan bangga.",
                "Disiplin adalah jembatan antara tujuan dan pencapaian. Terapkan hari ini.",
                "Berhenti menunda. Lakukan yang terbaik sekarang, hasilnya akan mengikuti.",
                "Wanita Karo yang cerdas tahu kapan harus tegas dan kapan harus lembut.",
                "Jangan takut untuk memaafkan, baik orang lain maupun diri sendiri. Beban hati menghambat laju.",
                "Anda adalah pembuat keputusan. Ambil kendali atas pilihan-pilihan hidup Anda.",
                "Jadilah teladan dalam segala hal: integritas, semangat kerja, dan pengabdian keluarga.",
                "Optimisme adalah bahan bakar Anda. Lihatlah tantangan sebagai peluang.",
                "Berinvestasi pada diri sendiri adalah investasi terbaik untuk keluarga Anda.",
                "Ucapkan terima kasih (bujur) pada diri sendiri atas semua yang telah Anda capai sejauh ini.",
                "Tanamkan semangat persatuan di antara sesama Beru dan Nande Karo.",
            ];

            const messages = [];
            // Mulai dari 1 Januari 2026
            const startDate = new Date('2026-01-01T12:00:00Z'); 
            
            // Opsi format tanggal Indonesia
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            const daysInYear = DAYS_IN_YEAR;
            let dailyMessageCounter = 0;
            let restMessageCounter = 0;
            
            for (let i = 0; i < daysInYear; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                // Format tanggal Indonesia
                const formatter = new Intl.DateTimeFormat('id-ID', options);
                const dateString = formatter.format(currentDate);
                
                let selectedMessage;
                // Cek hari: 0 = Minggu (Sunday)
                if (currentDate.getDay() === 0) {
                    // Jika Hari Minggu, pilih dari pool restMessages (menggunakan modulo untuk mengulang jika perlu)
                    selectedMessage = restMessages[restMessageCounter % restMessages.length];
                    restMessageCounter++;
                } else {
                    // Jika Hari Kerja, pilih dari pool dailyMessages (menggunakan modulo untuk mengulang jika perlu)
                    selectedMessage = dailyMessages[dailyMessageCounter % dailyMessages.length]; 
                    dailyMessageCounter++;
                }

                messages.push({
                    message: selectedMessage, 
                    date: dateString 
                });
            }
            
            return messages;
        }

        /**
         * FUNGSI HELPER UNTUK MENGACAK DAN MEMUAT GAMBAR DENGAN RETRY
         */

        // Fungsi untuk menghasilkan URL Picsum acak
        function generateRandomImageUrl(width, height) {
            const newId = Math.floor(Math.random() * PICSUM_MAX_ID) + 1;
            return `https://picsum.photos/id/${newId}/${width}/${height}`;
        }

        // Fungsi untuk menghasilkan daftar 365 ID Picsum acak unik
        function generateRandomPicsumIds(count) {
            const ids = new Set();
            while (ids.size < count) {
                ids.add(Math.floor(Math.random() * PICSUM_MAX_ID) + 1);
            }
            return Array.from(ids);
        }

        /**
         * Memuat gambar dengan mekanisme coba ulang (retry) jika gagal.
         */
        function loadImageWithRetry(initialUrl) {
            return new Promise((resolve) => {
                let attempts = 0;
                let currentUrl = initialUrl;

                const attemptLoad = () => {
                    attempts++;
                    const image = new Image();
                    image.crossOrigin = 'Anonymous';
                    image.src = currentUrl;

                    image.onload = () => resolve(image);

                    image.onerror = () => {
                        if (attempts < MAX_RETRIES) {
                            // Coba lagi dengan URL acak yang berbeda
                            currentUrl = generateRandomImageUrl(DEFAULT_WIDTH, DEFAULT_HEIGHT);
                            console.warn(`Gagal memuat gambar dari URL: ${image.src}. Mencoba lagi (Percobaan ${attempts}/${MAX_RETRIES}).`);
                            attemptLoad(); 
                        } else {
                            console.error(`Gagal memuat gambar setelah ${MAX_RETRIES} percobaan. Menggunakan fallback warna.`);
                            resolve(null); // Gagal total, kembalikan null untuk fallback
                        }
                    };
                };

                attemptLoad();
            });
        }
        
        const quotesData = generateYear2026Data();
        const totalImages = quotesData.length; // Akan menjadi 365
        
        // --- Inisialisasi URL Gambar Acak Unik untuk 365 hari ---
        const randomIds = generateRandomPicsumIds(totalImages);
        const imageUrls = randomIds.map(id => 
            `https://picsum.photos/id/${id}/${DEFAULT_WIDTH}/${DEFAULT_HEIGHT}`
        );
        // --- Akhir Inisialisasi ---


        // --- Event listeners untuk kontrol (tetap sama) ---
        document.getElementById('fontSizeEn').addEventListener('input', () => updatePreview(0));
        document.getElementById('fontSizeId').addEventListener('input', () => updatePreview(0));
        document.getElementById('textColor').addEventListener('input', () => updatePreview(0));
        document.getElementById('shadowColor').addEventListener('input', () => updatePreview(0));
        document.getElementById('bgContrast').addEventListener('input', () => updatePreview(0));
        document.getElementById('bgHue').addEventListener('input', () => updatePreview(0));
        document.getElementById('brandText').addEventListener('input', () => updatePreview(0));
        document.getElementById('logoSize').addEventListener('input', () => updatePreview(0));


        /**
         * Memecah teks menjadi baris
         */
        function wrapText(context, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0] || '';

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        /**
         * Menggambar overlay teks (termasuk logo, pesan, dan tanggal)
         */
        function drawTextOverlay(context, bgImg, data) {
            const bgW = DEFAULT_WIDTH;
            const bgH = DEFAULT_HEIGHT;
            
            const mainFontSize = parseInt(document.getElementById('fontSizeEn').value) || 48;
            const dateFontSize = parseInt(document.getElementById('fontSizeId').value) || 28;
            const textColor = document.getElementById('textColor').value;
            const shadowColor = document.getElementById('shadowColor').value;
            const brandText = document.getElementById('brandText').value; 
            const logoSize = parseInt(document.getElementById('logoSize').value) || 60; 
            
            const contrastValue = parseFloat(document.getElementById('bgContrast').value) || 1.0;
            const hueValue = parseInt(document.getElementById('bgHue').value) || 0;
            
            const padding = 60; 
            const maxWidth = bgW - (padding * 2);
            
            context.clearRect(0, 0, bgW, bgH);

            // Draw background
            const isBgLoaded = bgImg && bgImg.complete && bgImg.naturalWidth !== 0;

            if (isBgLoaded) {
                context.filter = `contrast(${contrastValue}) hue-rotate(${hueValue}deg)`;
                context.drawImage(bgImg, 0, 0, bgW, bgH);
                context.fillStyle = 'rgba(0, 0, 0, 0.5)'; // Overlay gelap
                context.fillRect(0, 0, bgW, bgH);
                context.filter = 'none'; // Hapus filter
            } else {
                // Fallback to gradient
                const gradient = context.createLinearGradient(0, 0, bgW, bgH);
                gradient.addColorStop(0, '#4b6cb7'); // Menggunakan warna baru HWKI
                gradient.addColorStop(1, '#182848');
                context.fillStyle = gradient;
                context.fillRect(0, 0, bgW, bgH);
            }
            
            // --- Draw Logo and Brand Text in Top Right ---
            const brandPadding = 40; 
            const logoY = brandPadding;

            context.fillStyle = '#ffffff';
            const brandFontSize = 28;
            context.font = `bold ${brandFontSize}px Segoe UI, sans-serif`;
            const textWidth = context.measureText(brandText).width;
            
            const currentLogoSize = logoSize;

            const totalWidth = logoLoaded ? (currentLogoSize + 15 + textWidth) : textWidth;
            const logoX = bgW - brandPadding - totalWidth;
            
            // Draw logo if loaded 
            if (logoLoaded) {
                context.shadowColor = shadowColor;
                context.shadowBlur = 5;
                context.shadowOffsetX = 2;
                context.shadowOffsetY = 2;
                context.drawImage(logoImage, logoX, logoY, currentLogoSize, currentLogoSize);
                context.shadowColor = 'transparent'; 
                context.shadowBlur = 0;
                context.shadowOffsetX = 0;
                context.shadowOffsetY = 0;
            }

            // Draw brand text (to the right of logo)
            context.shadowColor = shadowColor;
            context.shadowBlur = 5;
            context.shadowOffsetX = 2;
            context.shadowOffsetY = 2;

            context.textAlign = 'left';
            context.textBaseline = 'middle';
            const brandTextY = logoY + currentLogoSize / 2;
            const brandTextX = logoLoaded ? (logoX + currentLogoSize + 15) : logoX;
            context.fillText(brandText, brandTextX, brandTextY);
            
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;
            // --- Akhir Draw Logo and Brand Text ---


            // --- Draw Main Message and Date Text in Center ---
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            
            // 1. Calculate space for Message
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            const linesMessage = wrapText(context, data.message, maxWidth);
            const lineHeightMessage = mainFontSize * 1.4;
            const totalTextHeightMessage = linesMessage.length * lineHeightMessage;

            // 2. Calculate space for Date (Tanggal)
            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`; 
            const linesDate = wrapText(context, data.date, maxWidth); 
            const lineHeightDate = dateFontSize * 1.4;
            const totalTextHeightDate = linesDate.length * lineHeightDate;

            const spacing = 40; 
            const totalTextHeight = totalTextHeightMessage + spacing + totalTextHeightDate;

            let startY = (bgH - totalTextHeight) / 2;
            
            context.shadowColor = shadowColor;
            context.shadowBlur = 10;
            context.shadowOffsetX = 3;
            context.shadowOffsetY = 3;
            
            // 3. Draw Message Text
            context.fillStyle = textColor;
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesMessage.forEach((line, index) => {
                const yPos = startY + (index * lineHeightMessage) + (lineHeightMessage / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            // 4. Update startY for Date Text
            startY += totalTextHeightMessage + spacing;

            // 5. Draw Date Text
            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesDate.forEach((line, index) => {
                const yPos = startY + (index * lineHeightDate) + (lineHeightDate / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;
        }


        /**
         * FUNGSI UNTUK UPDATE PREVIEW
         */
        async function updatePreview(index) {
            const initialUrl = imageUrls[index % totalImages]; // Ambil URL berdasarkan indeks
            const data = quotesData[index % totalImages];
            
            document.getElementById('statusMessage').innerText = `Loading Preview Hari ke-${index + 1}/${totalImages} (Tahun 2026)...`;

            // Gunakan mekanisme retry untuk memuat gambar
            const image = await loadImageWithRetry(initialUrl);

            if (image) {
                // Berhasil dimuat (setelah 1 atau lebih percobaan)
                drawTextOverlay(ctx, image, data);
                document.getElementById('statusMessage').innerText = `Preview Hari ke-${index + 1}/${totalImages} ditampilkan. (Tanggal: ${data.date})`;
            } else {
                // Gagal total (menggunakan null untuk memicu fallback warna)
                drawTextOverlay(ctx, null, data); 
                document.getElementById('statusMessage').innerText = `Gagal memuat gambar Hari ke-${index + 1} setelah ${MAX_RETRIES} percobaan. Menampilkan background fallback warna.`;
            }
        }

        /**
         * FUNGSI MULTI-DOWNLOAD DENGAN JSZip MENGGUNAKAN WORKER POOL CONTINUOUS
         */
        async function downloadAllImages() {
            const zip = new JSZip();
            let filesProcessed = 0;
            let fallbacksUsed = 0;
            const totalFiles = imageUrls.length;
            const KUALITAS_KOMPRESI = 0.8; 
            const MAX_CONCURRENT = 10; // Batas koneksi serentak 

            if (totalFiles === 0) {
                 alert("Tidak ada data kutipan untuk diproses.");
                 return;
            }

            document.getElementById('statusMessage').innerText = `Mulai memproses ${totalFiles} gambar untuk 1 tahun... Harap tunggu. Proses akan berjalan mulus.`;

            // Array semua indeks yang perlu diproses (digunakan sebagai queue)
            const allIndices = Array.from({length: totalFiles}, (_, i) => i).reverse();

            /**
             * Fungsi pembantu untuk memuat, memproses, dan menambahkan satu file ke ZIP (mengembalikan Promise)
             */
            const processFile = (index) => {
                return new Promise(async (resolve) => {
                    const initialUrl = imageUrls[index];
                    const data = quotesData[index];

                    // Gunakan mekanisme retry
                    const image = await loadImageWithRetry(initialUrl);
                    const isFallback = (image === null);

                    const handleImageProcessing = (img, isFallback) => {
                        // 1. Buat kanvas baru di memori
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = DEFAULT_WIDTH;
                        tempCanvas.height = DEFAULT_HEIGHT;
                        const tempCtx = tempCanvas.getContext('2d');

                        // 2. Gambar overlay teks
                        drawTextOverlay(tempCtx, img, data); 
                        
                        // 3. Tentukan nama file
                        // Ambil 30 karakter pertama dari pesan utama untuk nama file
                        const messageText = data.message.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_').trim(); 
                        const fallbackSuffix = isFallback ? '_FALLBACK' : '';
                        const fileName = `HWKI_2026_${index + 1}_${messageText}${fallbackSuffix}.jpeg`; 

                        // 4. Konversi ke Data URL JPEG dan ambil Base64
                        const dataUrl = tempCanvas.toDataURL('image/jpeg', KUALITAS_KOMPRESI);
                        const base64Data = dataUrl.split(',')[1];
                        zip.file(fileName, base64Data, {base64: true});

                        filesProcessed++;
                        if (isFallback) fallbacksUsed++;
                        
                        // PENTING: Update status secara kontinyu
                        document.getElementById('statusMessage').innerText = `Memproses... ${filesProcessed}/${totalFiles} selesai (Sukses: ${filesProcessed - fallbacksUsed}, Fallback: ${fallbacksUsed}).`;

                        resolve(); 
                    };

                    handleImageProcessing(image, isFallback);
                });
            };
            
            // --- LOGIKA WORKER POOL CONTINUOUS ---

            // Fungsi Worker: Mengambil tugas (indeks) dari queue hingga queue kosong
            const worker = async () => {
                let index;
                // Selama masih ada indeks di array, ambil dan proses
                while ((index = allIndices.pop()) !== undefined) {
                    await processFile(index);
                }
            };
            
            // Jalankan sejumlah worker (10) serentak
            const workers = Array(MAX_CONCURRENT).fill(null).map(() => worker());

            // Tunggu hingga semua pekerja menyelesaikan semua tugas
            await Promise.all(workers);
            
            // --- AKHIR LOGIKA WORKER POOL ---

            // 6. Generate dan Download ZIP setelah semua file diproses
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "365_Penyemangat_Wanita_Karo_2026.zip");
                document.getElementById('statusMessage').innerText = `‚úÖ Selesai! File ZIP berisi ${totalFiles} gambar (1 tahun penuh) berhasil diunduh.`;
            });
        }

        // Initial render (Hari ke-1)
        updatePreview(0);
    </script>
</body>
</html>