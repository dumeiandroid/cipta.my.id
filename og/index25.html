<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Video + Ken Burns Acak + Cross-Fade + 2 Audio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* CSS DARI KODE SEBELUMNYA (dipertahankan) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1300px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="number"],
        input[type="url"],
        select,
        textarea,
        input[type="text"],
        input[type="range"],
        input[type="file"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4b6cb7; 
            border-radius: 50%;
            cursor: pointer;
        }


        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: 700;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4b6cb7; 
            grid-column: 1 / -1;
        }

        .audio-input-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .audio-input-group > .input-group:nth-child(3) {
             grid-column: 1 / -1;
        }
        
        /* Hilangkan input scale start/end yang lama, karena sekarang diacak */
        #scaleStart, #scaleEnd {
            display: none;
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Generator Video + Ken Burns Acak + Cross-Fade</h1>
        <p class="subtitle">Setiap gambar latar akan memiliki gerakan yang unik dan transisi yang lembut (cross-fade).</p>

        <div class="controls">
            
            <div class="section-title">üîä Pengaturan Audio Latar (2 Track)</div>
            
            <div class="audio-input-group">
                <div class="input-group">
                    <label for="audioFileSpeech">Pilih File Suara Berbicara (Narasi):</label>
                    <input type="file" id="audioFileSpeech" accept="audio/mp3, audio/ogg, audio/wav">
                </div>
                
                <div class="input-group">
                    <label>Volume Narasi (0.0 - 2.0):</label>
                    <input type="range" id="audioVolumeSpeech" value="1.0" min="0.0" max="2.0" step="0.01">
                </div>
                <div class="input-group">
                    <audio id="audioSourceSpeech" controls loop style="width: 100%;"></audio>
                </div>
            </div>

            <div class="audio-input-group">
                <div class="input-group">
                    <label for="audioFileMusic">Pilih File Musik Latar (Backsound):</label>
                    <input type="file" id="audioFileMusic" accept="audio/mp3, audio/ogg, audio/wav">
                </div>

                <div class="input-group">
                    <label>Volume Musik (0.0 - 2.0):</label>
                     <input type="range" id="audioVolumeMusic" value="0.3" min="0.0" max="2.0" step="0.01">
                </div>
                 <div class="input-group">
                    <audio id="audioSourceMusic" controls loop style="width: 100%;"></audio>
                </div>
            </div>

            <div class="section-title">üñºÔ∏è Pengaturan Ken Burns Effect & Transisi</div>
            
             <div class="input-group" style="grid-column: 1 / -1;">
                <label>Efek Ken Burns:</label>
                <span class="help-text">Gerakan (Zoom/Pan) akan dipilih secara acak untuk setiap hari secara otomatis.</span>
            </div>
            
             <div class="input-group" style="grid-column: 1 / -1;">
                <label>Durasi & Transisi Gambar/Teks:</label>
                <span class="help-text">Gambar berganti setiap 10 detik. Teks berganti acak antara 2.0-4.5 detik. Cross-Fade Gambar 1s, Teks 0.5s.</span>
                <input type="number" id="scaleStart" value="1.0" min="0.5" max="2.0" step="0.05">
                <input type="number" id="scaleEnd" value="1.2" min="0.5" max="2.0" step="0.05">
            </div>


            <div class="section-title">üé® Pengaturan Tampilan</div>
            
            <div class="input-group">
                <label>Ukuran Font (Pesan Utama):</label>
                <input type="number" id="fontSizeEn" value="48" min="20" max="150">
            </div>

            <div class="input-group">
                <label>Ukuran Font (Tanggal):</label>
                <input type="number" id="fontSizeId" value="28" min="15" max="100">
            </div>

            <div class="input-group">
                <label>Warna Teks:</label>
                <input type="color" id="textColor" value="#ffffff">
            </div>
            
            <div class="input-group">
                <label>Warna Shadow Teks:</label>
                <input type="color" id="shadowColor" value="#000000">
            </div>

            <div class="section-title">üñºÔ∏è Pengaturan Background & Branding</div>

            <div class="input-group">
                <label>Kontras Gambar Background (0.5 - 2.0):</label>
                <input type="number" id="bgContrast" value="1.0" min="0.5" max="2.0" step="0.1">
            </div>
            
            <div class="input-group">
                <label>Warna Gambar Background (Hue Rotate):</label>
                <input type="range" id="bgHue" value="0" min="0" max="360" step="1">
            </div>
            
            <div class="input-group">
                <label>URL Logo:</label>
                <input type="url" id="logoUrl" value="https://cipta.my.id/og/gambar/logo-wki.png" placeholder="https://example.com/logo.png">
            </div>

            <div class="input-group">
                <label>Teks Brand:</label>
                <input type="text" id="brandText" value="Himpunan Wanita Karo Indonesia" placeholder="Nama Brand">
            </div>

            <div class="input-group">
                <label>Ukuran Logo:</label>
                <input type="number" id="logoSize" value="60" min="30" max="150">
            </div>
            
        </div>

        <div class="canvas-container">
            <canvas id="canvas" width="1200" height="630"></canvas>
        </div>

        <div class="button-group">
            <button id="previewBtn" onclick="updatePreview(0)">üîÑ Preview Hari ke-1</button>
            <button id="downloadVideoBtn" onclick="startVideoRecording()">‚ñ∂Ô∏è Start Generate & Download Video (WebM)</button> 
        </div>

        <p id="statusMessage" style="text-align: center; margin-top: 20px; font-weight: bold; color: #333;"></p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Elemen Audio
        const audioFileInputSpeech = document.getElementById('audioFileSpeech');
        const audioElSpeech = document.getElementById('audioSourceSpeech');
        const audioFileInputMusic = document.getElementById('audioFileMusic');
        const audioElMusic = document.getElementById('audioSourceMusic');
        
        const DEFAULT_WIDTH = 1200;
        const DEFAULT_HEIGHT = 630;
        const PICSUM_MAX_ID = 1000;
        
        // --- KONSTANTA BARU UNTUK DURASI INDEPENDEN ---
        const IMAGE_DURATION = 10000; // Gambar berganti setiap 10 detik
        const MIN_TEXT_DURATION = 2000; // Minimal durasi teks 2.0 detik
        const MAX_TEXT_DURATION = 4500; // Maksimal durasi teks 4.5 detik
        
        const TRANSITION_DURATION = 1000; // 1 detik cross-fade gambar
        const TEXT_FADE_DURATION = 500; // 0.5 detik fade-in/out teks
        const FPS = 30; // Frame per detik untuk rekaman
        const MAX_RETRIES = 3;

        let logoImage = new Image();
        let logoLoaded = false;
        
        let mediaRecorder;
        let videoChunks = [];
        
        // INDICES INDEPENDEN
        let currentImageIndex = 0; 
        let currentTextIndex = 0; 

        let animationFrameId;
        let currentImage = null;
        let previousImage = null; 
        let isRecording = false;
        let frameSettings = []; // Pengaturan Ken Burns per gambar (31)
        let cumulativeTextDuration = []; // Array untuk melacak kapan setiap teks harus ganti
        let totalVideoDuration = 0; // Durasi total video (berdasarkan total durasi teks)

        let audioContext = null;
        let gainNodeSpeech = null;
        let gainNodeMusic = null;
        let audioStreamDestination = null;
        let startTime = 0; 
        let lastTextRendered = -1; // Melacak kapan terakhir teks diganti

        // =========================================================
        // === UTILITY FUNCTIONS ===
        // =========================================================

        function lerp(start, end, t) {
            return start * (1 - t) + end * t;
        }

        function wrapText(context, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0] || '';

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
        
        function generateRandomDuration() {
             // Durasi acak antara MIN_TEXT_DURATION hingga MAX_TEXT_DURATION
            return Math.floor(Math.random() * (MAX_TEXT_DURATION - MIN_TEXT_DURATION + 1)) + MIN_TEXT_DURATION; 
        }

        function generateDecember2025Data() {
            // Data pesan dipertahankan
            const restMessages = [
                { message: "Nande, berhenti sejenak. Kekuatanmu bukan hanya dalam bekerja, tapi dalam kemampuanmu untuk pulih." },
                { message: "Hari ini, bebaskan uis (pakaian) dari beban pikiran. Isi ulang semangat Nande-Nande Karo!" },
                { message: "Keseimbangan dimulai saat Anda memberi izin pada diri sendiri untuk istirahat. Selamat hari Minggu!" },
                { message: "Anda adalah pengerajut keharmonisan rumah. Jeda hari ini untuk memastikan benang Anda kuat kembali." },
                { message: "Istirahat adalah investasi. Nande yang bahagia adalah keluarga yang sejahtera." },
                { message: "Adil pada diri sendiri berarti memberi jeda. Jangan biarkan produktivitas mencuri kedamaian Anda." },
                { message: "Penting untuk meluangkan waktu bagi diri sendiri, sebelum kembali menjadi pilar bagi keluarga dan komunitas." },
                { message: "Rayakan ketenangan. Di hari istirahat ini, jadilah ratu di rumah batin Anda. Mejuah-juah!" },
                { message: "Biarkan energi Runggu (kumpul/musyawarah) Anda pulih. Besok, Anda akan bersinar lebih terang." },
                { message: "Kenakan senyum terindah hari ini. Tenang dan santai, itu juga sebuah pencapaian yang mulia." },
            ];
            const dailyMessages = [
                { message: "Sebagai Nande, kasih sayangmu adalah warisan terpenting bagi anak-anak. Jangan pernah ragu akan nilai itu." },
                { message: "Kehangatanmu di rumah adalah fondasi kokoh untuk setiap langkah karir dan cita-cita keluarga." },
                { message: "Nande yang kuat mendidik generasi yang tangguh. Pekerjaanmu di rumah adalah yang termulia." },
                { message: "Dukunganmu sebagai istri adalah sayap yang mengangkat pasanganmu mencapai puncak. Anda sangat berharga." },
                { message: "Setiap makanan yang kamu sajikan adalah perwujudan cinta. Jangan anggap remeh keahlianmu ini." },
                { message: "Kecerdasan emosionalmu, Nande, adalah kunci untuk menyelesaikan setiap Runggu keluarga dengan damai." },
                { message: "Anda adalah benteng kebudayaan di rumah. Lestarikan nilai-nilai Karo dengan bangga." },
                { message: "Jangan takut meminta bantuan. Kekuatan sejati ada pada kolaborasi dalam keluarga. Bersatu kita teguh." },
                { message: "Dengan semangat Mejuah-Juah, bawa energi positif dan ketegasan ke tempat kerja Anda." },
                { message: "Seorang wanita Karo adalah penenun takdirnya sendiri. Tetapkan tujuan dan kejar dengan gigih." },
                { message: "Jangan pernah meremehkan bakat negosiasi dan kepemimpinan yang Anda miliki. Itu warisan leluhur." },
                { message: "Pendidikan dan karir Anda adalah bukti bahwa wanita Karo mampu bersaing di panggung global." },
                { message: "Keberanian dan ketegasan adalah Raga (pakaian, diri) Anda di dunia profesional. Tunjukkan sinarmu!" },
                { message: "Setiap tantangan di kantor adalah kesempatan untuk menunjukkan ketangguhan Beru/Nande Karo!" },
                { message: "Keseimbangan karir dan keluarga bukanlah pengorbanan, melainkan manajemen waktu yang cerdas." },
                { message: "Jadilah inspirasi bagi wanita muda Karo lainnya melalui dedikasi dan integritas Anda." },
                { message: "Wanita Karo memegang peran ganda dengan anggun. Hargai kemampuan multitasking Anda hari ini." },
                { message: "Ingatlah, berkarir tidak mengurangi peran Anda sebagai ibu, justru menambah dimensi kekuatan." },
                { message: "Anda adalah penjaga tradisi dan perintis masa depan. Lakukan keduanya dengan kepala tegak." },
                { message: "Nilai seorang wanita diukur dari hatinya yang melayani, bukan dari seberapa sibuk jadwalnya." },
                { message: "Kekuatan leluhur mengalir dalam darahmu. Gunakan warisan itu untuk melewati kesulitan hari ini." },
                { message: "Ciptakan lingkungan yang mendukung, baik di rumah maupun di tempat kerja. Anda pantas mendapatkannya." },
                { message: "Setiap tetes keringatmu, Nande, adalah doa yang diwujudkan dalam tindakan. Selamat berjuang!" },
                { message: "Jangan biarkan standar orang lain mendikte kebahagiaan Anda. Bahagia versi Anda adalah yang terpenting." },
                { message: "Wanita Karo berani berbicara dan mengambil peran. Suaramu penting dan layak didengar." },
                { message: "Fokus pada kemajuan kecil hari ini. Setiap langkah membawa Anda pada impian besarmu." },
                { message: "Sebagai tiang keluarga, pastikan tiangmu tetap berdiri tegak. Jaga kesehatan fisik dan mental." },
                { message: "Percayalah pada insting Anda sebagai seorang ibu dan istri. Hati Nande jarang salah." },
                { message: "Bekerja keraslah, tetapi jangan lupa untuk merayakan diri sendiri atas semua pencapaian." },
                { message: "Tunjukkan pada dunia bahwa kelembutan dan kekuatan dapat hidup berdampingan dalam diri seorang wanita Karo." },
                { message: "Hari ini, jadilah pelopor di bidang Anda. Jangan ikuti jejak, buat jejakmu sendiri." },
                { message: "Ciptakan batasan yang sehat. Anda berhak melindungi waktu dan energi pribadi Anda." },
                { message: "Kemandirian ekonomi adalah kekuatan. Lanjutkan perjalanan Anda menuju kemandirian penuh." },
                { message: "Anda adalah duta budaya. Banggalah dengan marga dan asal usulmu, dan tunjukkan pesonanya." },
                { message: "Jangan pernah merasa bersalah karena ambisi Anda. Wanita Karo dirancang untuk menjadi luar biasa." },
                { message: "Perlakukan kegagalan sebagai batu loncatan. Jatuh itu biasa, bangkit itu luar biasa." },
                { message: "Hari ini adalah kesempatan untuk menginspirasi satu orang. Mulailah dengan menginspirasi diri sendiri." },
                { message: "Ambil waktu 5 menit untuk bernapas dan bersyukur. Fokus pada apa yang Anda miliki, bukan yang kurang." },
                { message: "Wanita Karo: Tangguh di gunung, lembut di hati. Keseimbangan ini adalah kekuatan super Anda." },
                { message: "Lanjutkan tradisi kebaikan. Warisan terbaik yang Anda berikan adalah karakter mulia." },
                { message: "Mejuah-juah! Semoga berkat dan kesuksesan menyertai setiap usaha baik Anda hari ini." },
                { message: "Jadilah cermin bagi generasi muda, tunjukkan definisi sejati dari keberanian dan integritas." }
            ];

            const messages = [];
            const startDate = new Date('2025-12-01T12:00:00Z'); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const daysInMonth = 31;
            let dailyMessageCounter = 0;
            let restMessageCounter = 0;
            
            for (let i = 0; i < daysInMonth; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const formatter = new Intl.DateTimeFormat('id-ID', options);
                const dateString = formatter.format(currentDate);
                let selectedMessageData;
                if (currentDate.getDay() === 0) {
                    selectedMessageData = restMessages[restMessageCounter % restMessages.length];
                    restMessageCounter++;
                } else {
                    selectedMessageData = dailyMessages[dailyMessageCounter % dailyMessages.length]; 
                    dailyMessageCounter++;
                }

                messages.push({
                    message: selectedMessageData.message, 
                    date: dateString,
                    duration: generateRandomDuration() // Durasi Teks Acak (2000-4500ms)
                });
            }
            
            return messages;
        }

        // Fungsi precalculasi untuk mendukung timer teks independen
        function precalculateDurations(quotesData) {
            let cumulative = 0;
            cumulativeTextDuration = [];
            quotesData.forEach(data => {
                cumulative += data.duration;
                cumulativeTextDuration.push(cumulative);
            });
            return cumulative; 
        }

        function generateRandomImageUrl(width, height) {
            const newId = Math.floor(Math.random() * PICSUM_MAX_ID) + 1;
            return `https://picsum.photos/id/${newId}/${width}/${height}`;
        }

        function generateRandomPicsumIds(count) {
            const ids = new Set();
            while (ids.size < count) {
                ids.add(Math.floor(Math.random() * PICSUM_MAX_ID) + 1);
            }
            return Array.from(ids);
        }

        function loadImageWithRetry(initialUrl) {
            return new Promise((resolve) => {
                let attempts = 0;
                let currentUrl = initialUrl;

                const attemptLoad = () => {
                    attempts++;
                    const image = new Image();
                    image.crossOrigin = 'Anonymous';
                    image.src = currentUrl;

                    image.onload = () => resolve(image);

                    image.onerror = () => {
                        if (attempts < MAX_RETRIES) {
                            currentUrl = generateRandomImageUrl(DEFAULT_WIDTH, DEFAULT_HEIGHT);
                            console.warn(`Gagal memuat gambar dari URL: ${image.src}. Mencoba lagi (Percobaan ${attempts}/${MAX_RETRIES}).`);
                            attemptLoad(); 
                        } else {
                            console.error(`Gagal memuat gambar setelah ${MAX_RETRIES} percobaan. Menggunakan fallback warna.`);
                            resolve(null); 
                        }
                    };
                };

                attemptLoad();
            });
        }
        
        // --- LOGIKA KEN BURNS ACAK ---
        function generateRandomKenBurnsParams() {
             const presets = [
                // Zoom In + Pan Kiri Bawah (Subtle)
                { scaleStart: 1.05, scaleEnd: 1.1, panXStart: 0, panYStart: 0, panXEnd: -0.05, panYEnd: -0.05 }, 
                
                // Zoom Out + Pan Kanan Atas (Subtle)
                { scaleStart: 1.1, scaleEnd: 1.05, panXStart: -0.05, panYStart: -0.05, panXEnd: 0, panYEnd: 0 }, 
                
                // Pan Kanan (Skala tetap, Subtle)
                { scaleStart: 1.05, scaleEnd: 1.05, panXStart: 0.05, panYStart: 0, panXEnd: 0, panYEnd: 0 }, 
                
                // // Zoom In Saja (Pusat, Subtle)
                { scaleStart: 1.0, scaleEnd: 1.05, panXStart: 0, panYStart: 0, panXEnd: 0, panYEnd: 0 }, 
            ];
            const randomIndex = Math.floor(Math.random() * presets.length);
            return presets[randomIndex];
        }


        // =========================================================
        // === DRAWING & CONTENT LOADING FUNCTIONS ===
        // =========================================================

        function drawBackgroundOnly(context, bgImg, settings, t, globalOpacity = 1.0) {
            if (!bgImg || !bgImg.complete || bgImg.naturalWidth === 0 || !settings) {
                 // Fallback (jika gambar gagal dimuat)
                const gradient = context.createLinearGradient(0, 0, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                gradient.addColorStop(0, '#4b6cb7'); 
                gradient.addColorStop(1, '#182848');
                context.fillStyle = gradient;
                context.fillRect(0, 0, DEFAULT_WIDTH, DEFAULT_HEIGHT);
                return;
            }

            const bgW = DEFAULT_WIDTH;
            const bgH = DEFAULT_HEIGHT;

            const contrastValue = parseFloat(document.getElementById('bgContrast').value) || 1.0;
            const hueValue = parseInt(document.getElementById('bgHue').value) || 0;

            const pivotX = bgW / 2;
            const pivotY = bgH / 2;

            const currentScale = lerp(settings.scaleStart, settings.scaleEnd, t);
            
            // PanX/Y Start/End adalah persentase (misal 0.1 = 10% dari lebar/tinggi)
            const currentPanX = lerp(settings.panXStart * bgW, settings.panXEnd * bgW, t);
            const currentPanY = lerp(settings.panYStart * bgH, settings.panYEnd * bgH, t);

            context.save(); 
            context.filter = `contrast(${contrastValue}) hue-rotate(${hueValue}deg)`;
            context.globalAlpha = globalOpacity;

            context.translate(pivotX, pivotY); 
            context.scale(currentScale, currentScale); 
            context.translate(currentPanX / currentScale, currentPanY / currentScale); 

            context.drawImage(bgImg, -pivotX, -pivotY, bgW, bgH);
            
            context.filter = 'none'; 
            context.fillStyle = 'rgba(0, 0, 0, 0.5)'; // Overlay gelap
            context.fillRect(-pivotX, -pivotY, bgW, bgH); 

            context.restore(); 
            context.globalAlpha = 1.0;
        }

        function drawTextOverlay(context, data, alpha = 1.0) {
            const bgW = DEFAULT_WIDTH;
            const bgH = DEFAULT_HEIGHT;
            
            const mainFontSize = parseInt(document.getElementById('fontSizeEn').value) || 48;
            const dateFontSize = parseInt(document.getElementById('fontSizeId').value) || 28;
            const textColor = document.getElementById('textColor').value;
            const shadowColor = document.getElementById('shadowColor').value;
            const brandText = document.getElementById('brandText').value; 
            const logoSize = parseInt(document.getElementById('logoSize').value) || 60; 
            
            const padding = 60; 
            const maxWidth = bgW - (padding * 2);
            
            const brandPadding = 40; 
            const logoY = brandPadding;
            context.fillStyle = '#ffffff';
            const brandFontSize = 28;
            context.font = `bold ${brandFontSize}px Segoe UI, sans-serif`;
            const textWidth = context.measureText(brandText).width;
            const currentLogoSize = logoSize;
            const totalWidth = logoLoaded ? (currentLogoSize + 15 + textWidth) : textWidth;
            const logoX = bgW - brandPadding - totalWidth;
            
            context.globalAlpha = alpha; 

            // Draw Logo
            if (logoLoaded) {
                context.shadowColor = shadowColor;
                context.shadowBlur = 5;
                context.shadowOffsetX = 2;
                context.shadowOffsetY = 2;
                context.drawImage(logoImage, logoX, logoY, currentLogoSize, currentLogoSize);
                context.shadowColor = 'transparent'; 
                context.shadowBlur = 0;
                context.shadowOffsetX = 0;
                context.shadowOffsetY = 0;
            }

            // Draw Brand Text
            context.shadowColor = shadowColor;
            context.shadowBlur = 5;
            context.shadowOffsetX = 2;
            context.shadowOffsetY = 2;

            context.textAlign = 'left';
            context.textBaseline = 'middle';
            const brandTextY = logoY + currentLogoSize / 2;
            const brandTextX = logoLoaded ? (logoX + currentLogoSize + 15) : logoX;
            context.fillText(brandText, brandTextX, brandTextY);
            
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;

            // Draw Main Text
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            const linesMessage = wrapText(context, data.message, maxWidth);
            const lineHeightMessage = mainFontSize * 1.4;
            const totalTextHeightMessage = linesMessage.length * lineHeightMessage;

            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`; 
            const linesDate = wrapText(context, data.date, maxWidth); 
            const lineHeightDate = dateFontSize * 1.4;
            const totalTextHeightDate = linesDate.length * lineHeightDate;

            const spacing = 40; 
            const totalTextHeight = totalTextHeightMessage + spacing + totalTextHeightDate;

            let startY = (bgH - totalTextHeight) / 2;
            
            context.shadowColor = shadowColor;
            context.shadowBlur = 10;
            context.shadowOffsetX = 3;
            context.shadowOffsetY = 3;
            
            context.fillStyle = textColor;
            context.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesMessage.forEach((line, index) => {
                const yPos = startY + (index * lineHeightMessage) + (lineHeightMessage / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            startY += totalTextHeightMessage + spacing;

            context.font = `${dateFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
            linesDate.forEach((line, index) => {
                const yPos = startY + (index * lineHeightDate) + (lineHeightDate / 2);
                context.fillText(line, bgW / 2, yPos);
            });
            
            context.globalAlpha = 1.0; 
            context.shadowColor = 'transparent';
            context.shadowBlur = 0;
            context.shadowOffsetX = 0;
            context.shadowOffsetY = 0;
        }

        async function loadNewImageContent(index) {
            // Memastikan index tidak melebihi batas (walaupun teks mungkin masih berjalan)
            const actualIndex = Math.min(index, totalImages - 1);

            const initialUrl = imageUrls[actualIndex];
            
            // Simpan gambar saat ini sebagai "previousImage" sebelum memuat yang baru
            if (currentImage) {
                previousImage = currentImage;
            }

            const image = await loadImageWithRetry(initialUrl);
            currentImage = image; 
            
            if (isRecording) {
                 // Update status hanya saat recording agar user tahu gambar mana yang sedang diproses
                document.getElementById('statusMessage').innerText = `üé• RECORDING... Gambar ke-${actualIndex + 1}/${totalImages} (Durasi: ${IMAGE_DURATION/1000} detik).`;
            }
        }
        
        async function updatePreview(index) {
            if (isRecording) return; 

            // Untuk preview statis, kita hanya perlu memuat gambar dan teks yang sesuai dengan index
            currentImageIndex = index;
            currentTextIndex = index;

            await loadNewImageContent(currentImageIndex);
            
            const data = quotesData[currentTextIndex];

            // Render statis dengan t=0
             drawBackgroundOnly(ctx, currentImage, frameSettings[currentImageIndex].kenBurns, 0, 1.0);
             drawTextOverlay(ctx, data, 1.0);
             document.getElementById('statusMessage').innerText = `Preview Hari ke-${index + 1}/${totalImages} ditampilkan. (Tanggal: ${data.date}) | Durasi Teks: ${data.duration/1000}s.`;
        }


        // =========================================================
        // === AUDIO & CONTROL FUNCTIONS ===
        // =========================================================
        
        function setupAudioFileListener(inputElement, audioElement) {
            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        audioElement.src = event.target.result;
                        audioElement.load();
                        document.getElementById('statusMessage').innerText = `File audio '${file.name}' berhasil dimuat.`;
                    };
                    reader.readAsDataURL(file);
                } else {
                     audioElement.removeAttribute('src');
                     audioElement.load();
                }
            });
        }

        function setupAudioStream() {
            // ... (Kode Audio Setup Dipertahankan, mendukung volume 0.0 - 2.0)
            const isSpeechLoaded = !!audioElSpeech.src;
            const isMusicLoaded = !!audioElMusic.src;
            
            if (!isSpeechLoaded && !isMusicLoaded) {
                document.getElementById('statusMessage').innerText = "‚ö†Ô∏è Harap unggah minimal satu file audio (Narasi atau Musik) terlebih dahulu!";
                return null;
            }

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (!audioStreamDestination) {
                audioStreamDestination = audioContext.createMediaStreamDestination();
            }

            let trackCount = 0;
            
            // --- 1. Setup Stream Narasi ---
            if (isSpeechLoaded) {
                if (gainNodeSpeech) gainNodeSpeech.disconnect(); 
                
                const sourceSpeech = audioContext.createMediaElementSource(audioElSpeech);
                gainNodeSpeech = audioContext.createGain();
                
                const volumeSpeech = document.getElementById('audioVolumeSpeech');
                gainNodeSpeech.gain.value = parseFloat(volumeSpeech.value);
                volumeSpeech.oninput = () => {
                    gainNodeSpeech.gain.value = parseFloat(volumeSpeech.value);
                };
                
                sourceSpeech.connect(gainNodeSpeech);
                gainNodeSpeech.connect(audioStreamDestination);
                gainNodeSpeech.connect(audioContext.destination); 
                trackCount++;
            } else if (gainNodeSpeech) {
                gainNodeSpeech.disconnect();
                gainNodeSpeech = null;
            }

            // --- 2. Setup Stream Musik ---
            if (isMusicLoaded) {
                if (gainNodeMusic) gainNodeMusic.disconnect(); 
                
                const sourceMusic = audioContext.createMediaElementSource(audioElMusic);
                gainNodeMusic = audioContext.createGain();

                const volumeMusic = document.getElementById('audioVolumeMusic');
                gainNodeMusic.gain.value = parseFloat(volumeMusic.value);
                volumeMusic.oninput = () => {
                    gainNodeMusic.gain.value = parseFloat(volumeMusic.value);
                };
                
                sourceMusic.connect(gainNodeMusic);
                gainNodeMusic.connect(audioStreamDestination);
                gainNodeMusic.connect(audioContext.destination); 
                trackCount++;
            } else if (gainNodeMusic) {
                gainNodeMusic.disconnect();
                gainNodeMusic = null;
            }
            
            if (trackCount === 0) {
                 document.getElementById('statusMessage').innerText = "‚ö†Ô∏è Harap unggah minimal satu file audio!";
                 return null;
            }

            const audioTrack = audioStreamDestination.stream.getAudioTracks()[0];
            
            if (!audioTrack) {
                throw new Error("Gagal mendapatkan Audio Track Gabungan.");
            }
            
            return audioTrack;
        }

        // =========================================================
        // === FUNGSI INTI ANIMASI (MODIFIKASI UTAMA) ===
        // =========================================================
        function findTextIndex(elapsedTime) {
            for (let i = 0; i < cumulativeTextDuration.length; i++) {
                if (elapsedTime < cumulativeTextDuration[i]) {
                    return i;
                }
            }
            return cumulativeTextDuration.length; // Jika sudah melewati semua durasi
        }
        
        function animateFrame(timestamp) {
            if (!startTime) startTime = timestamp;
            let totalElapsedTime = timestamp - startTime; // Total waktu berlalu sejak rekaman dimulai

            // 1. Cek apakah video sudah selesai (berdasarkan total durasi Teks)
            if (totalElapsedTime >= totalVideoDuration) {
                stopRecording();
                return; 
            }
            
            // 2. Tentukan INDEKS TEKS saat ini (Text Index)
            const newTextIndex = findTextIndex(totalElapsedTime);
            
            // 3. Tentukan INDEKS GAMBAR saat ini (Image Index)
            // Gambar berganti setiap 10 detik
            const newImageIndex = Math.floor(totalElapsedTime / IMAGE_DURATION);

            // 4. Handle PERGANTIAN GAMBAR
            if (newImageIndex !== currentImageIndex) {
                currentImageIndex = newImageIndex;
                loadNewImageContent(currentImageIndex);
            }
            
            // 5. Handle PERGANTIAN TEKS
            if (newTextIndex !== currentTextIndex) {
                currentTextIndex = newTextIndex;
            }
            
            // Teks yang ditampilkan dan pengaturan Ken Burns
            const currentData = quotesData[currentTextIndex];
            const currentImageSettings = frameSettings[currentImageIndex];


            // 6. Hitung Progress & Alpha
            
            // --- LOGIKA KEN BURNS (berdasarkan 10 detik Gambar) ---
            const timeInCurrentImageFrame = totalElapsedTime % IMAGE_DURATION;
            let t_image = timeInCurrentImageFrame / IMAGE_DURATION; // Progress Ken Burns (0.0 - 1.0)
            
            // --- LOGIKA IMAGE CROSS-FADE ---
            let opacity_prev_bg = 0.0;
            let opacity_current_bg = 1.0; 
            const isBgTransitioningIn = timeInCurrentImageFrame < TRANSITION_DURATION;
            
            if (isBgTransitioningIn) {
                const transitionProgress = timeInCurrentImageFrame / TRANSITION_DURATION;
                opacity_current_bg = transitionProgress; 
                opacity_prev_bg = 1.0 - transitionProgress; 
            } 

            // --- LOGIKA TEXT FADE (berdasarkan Durasi Teks Acak) ---
            const prevTextCumulative = currentTextIndex === 0 ? 0 : cumulativeTextDuration[currentTextIndex - 1];
            const timeInCurrentTextFrame = totalElapsedTime - prevTextCumulative;
            const currentTextDuration = quotesData[currentTextIndex].duration; 
            
            let opacity_text = 1.0;
            const textFadeInTime = TEXT_FADE_DURATION;
            const textFadeOutStartTime = currentTextDuration - TEXT_FADE_DURATION;

            if (timeInCurrentTextFrame < textFadeInTime) {
                 // Fade In Teks
                 opacity_text = timeInCurrentTextFrame / textFadeInTime;
            } else if (timeInCurrentTextFrame > textFadeOutStartTime) {
                 // Fade Out Teks
                 opacity_text = (currentTextDuration - timeInCurrentTextFrame) / TEXT_FADE_DURATION;
            } 

            opacity_text = Math.max(0.0, Math.min(1.0, opacity_text)); 
            opacity_prev_bg = Math.max(0.0, Math.min(1.0, opacity_prev_bg)); 
            opacity_current_bg = Math.max(0.0, Math.min(1.0, opacity_current_bg)); 

            ctx.clearRect(0, 0, DEFAULT_WIDTH, DEFAULT_HEIGHT); 

            // 7. Gambar Background Lama (Memudar Keluar)
            if (previousImage && currentImageIndex > 0 && isBgTransitioningIn) {
                 // Gambar sebelumnya digambar di posisi Ken Burns akhirnya (t=1.0) dari frame sebelumnya
                 drawBackgroundOnly(ctx, previousImage, frameSettings[currentImageIndex - 1].kenBurns, 1.0, opacity_prev_bg);
            }
            
            // 8. Gambar Background Baru (Memudar Masuk & Ken Burns berjalan)
            if (currentImage) {
                 drawBackgroundOnly(ctx, currentImage, currentImageSettings.kenBurns, t_image, opacity_current_bg);
            }
            
            // 9. Gambar Teks (di atas semua background)
            if (currentImage) {
                 drawTextOverlay(ctx, currentData, opacity_text); 
                 
                 // Update status saat teks berganti
                 if (currentTextIndex !== lastTextRendered) {
                    document.getElementById('statusMessage').innerText = 
                        `üé• RECORDING... Teks ke-${currentTextIndex + 1}/${totalImages} (durasi: ${currentTextDuration/1000}s). Gambar: ${currentImageIndex + 1}/${totalImages}.`;
                    lastTextRendered = currentTextIndex;
                }
            }

            animationFrameId = requestAnimationFrame(animateFrame);
        }

        async function startVideoRecording() {
            if (!window.MediaRecorder || !canvas.captureStream) {
                alert("Browser Anda tidak mendukung MediaStream Recording API yang dibutuhkan.");
                return;
            }

            let audioTrack = setupAudioStream();
            if (!audioTrack) {
                return; 
            }

            isRecording = true;
            document.getElementById('downloadVideoBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            
            const videoStream = canvas.captureStream(FPS); 
            const combinedStream = new MediaStream();
            combinedStream.addTrack(videoStream.getVideoTracks()[0]);
            combinedStream.addTrack(audioTrack); 

            videoChunks = [];
            
            const options = { mimeType: 'video/webm; codecs=vp9,opus' }; 

            try {
                mediaRecorder = new MediaRecorder(combinedStream, options);
            } catch (e) {
                 mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });
            }

            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    videoChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = function() {
                if (audioElSpeech.src) audioElSpeech.pause();
                if (audioElMusic.src) audioElMusic.pause();
                downloadVideo();
            };

            if (audioElSpeech.src) {
                audioElSpeech.currentTime = 0;
                audioElSpeech.play().catch(e => console.warn("Autoplay Narasi diblokir:", e));
            }
            if (audioElMusic.src) {
                audioElMusic.currentTime = 0;
                audioElMusic.play().catch(e => console.warn("Autoplay Musik diblokir:", e));
            }
            
            currentImageIndex = 0;
            currentTextIndex = 0;
            startTime = 0;
            lastTextRendered = -1;
            previousImage = null; 
            await loadNewImageContent(currentImageIndex); 

            mediaRecorder.start();
            animationFrameId = requestAnimationFrame(animateFrame);
            
            document.getElementById('statusMessage').innerText = `üé• Perekaman Dimulai! Teks ke-1... (Total durasi: ${totalVideoDuration / 1000} detik).`;
        }

        function stopRecording() {
            cancelAnimationFrame(animationFrameId);
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
        }
        
        function downloadVideo() {
            document.getElementById('statusMessage').innerText = "‚úÖ Selesai merekam! Menggabungkan video, harap tunggu...";
            
            const blob = new Blob(videoChunks, { type: 'video/webm' }); 
            const videoFileName = `31_Penyemangat_Wanita_Karo_INDEPENDENT_VIDEO.webm`;
            
            saveAs(blob, videoFileName);
            
            document.getElementById('downloadVideoBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('statusMessage').innerText = `üéâ Video ${videoFileName} berhasil diunduh.`;
        }
        
        // =========================================================
        // === INITIALIZATION (HARUS DI AKHIR) ===
        // =========================================================
        
        // Setup Audio File Listeners
        setupAudioFileListener(audioFileInputSpeech, audioElSpeech);
        setupAudioFileListener(audioFileInputMusic, audioElMusic);

        const quotesData = generateDecember2025Data();
        const totalImages = quotesData.length; 
        
        // Hitung durasi kumulatif dan total video (berdasarkan Teks)
        totalVideoDuration = precalculateDurations(quotesData);

        const randomIds = generateRandomPicsumIds(totalImages);
        const imageUrls = randomIds.map(id => 
            `https://picsum.photos/id/${id}/${DEFAULT_WIDTH}/${DEFAULT_HEIGHT}`
        );
        
        // Inisialisasi pengaturan Ken Burns acak untuk setiap gambar
        for (let i = 0; i < totalImages; i++) {
            frameSettings.push({
                kenBurns: generateRandomKenBurnsParams()
            });
        }

        // Inisialisasi Logo 
        logoImage.crossOrigin = 'Anonymous';
        logoImage.onload = () => { logoLoaded = true; updatePreview(currentImageIndex); };
        logoImage.onerror = () => { console.warn("Logo gagal dimuat, menggunakan teks saja."); logoLoaded = false; updatePreview(currentImageIndex); };
        logoImage.src = document.getElementById('logoUrl').value;

        // Initial render (Hari ke-1)
        updatePreview(0);
    </script>
</body>
</html>